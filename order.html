<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order | Jersey OMS</title>
  <link rel="icon" type="image/png" href="public/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
  <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <link rel="stylesheet" href="styles.css">
  <script defer src="script.js"></script>
  <script defer src="js/firebase-init.js"></script>
</head>
<body>
  <div class="app-frame">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <span class="brand">
          <img src="public/logo.png" alt="Brand logo" class="brand-logo">
        </span>
        <button class="icon-btn" id="sidebarToggle" aria-label="Toggle sidebar">
          <span class="material-symbols-outlined">menu_open</span>
        </button>
      </div>
      <nav class="sidebar-nav">
        <a class="nav-item" href="index.html"><i data-lucide="layout-dashboard"></i><span>Overview</span></a>
        <a class="nav-item" href="orders.html"><i data-lucide="shopping-bag"></i><span>Orders</span></a>
        <a class="nav-item" href="customers.html"><i data-lucide="users"></i><span>Customers</span></a>
        <a class="nav-item" href="billing.html"><i data-lucide="credit-card"></i><span>Billing</span></a>
        <a class="nav-item" href="reports.html"><i data-lucide="bar-chart-3"></i><span>Updates</span></a>
        <a class="nav-item" href="settings.html"><i data-lucide="settings"></i><span>Settings</span></a>
      </nav>
    </aside>

    <div class="main-area">
      <header class="topbar">
        <div class="topbar-left">
          <h1>Sales Order</h1>
        </div>
        <div class="topbar-actions">
          <button class="icon-circle" aria-label="Notifications"><i data-lucide="bell"></i></button>
          <button class="icon-circle" aria-label="Profile"><i data-lucide="user"></i></button>
        </div>
      </header>

      <main class="site-main">
        <div class="container">
          <form class="form-grid" id="orderForm">
            <div class="form-field">
              <label for="customerName">Customer Name</label>
              <input class="input" id="customerName" name="customerName" type="text" required />
            </div>
            <div class="form-field">
              <label for="mobile">Mobile Number</label>
              <input class="input" id="mobile" name="mobile" type="tel" inputmode="numeric" required />
            </div>
            <div class="form-field">
              <label for="email">Email</label>
              <input class="input" id="email" name="email" type="email" />
            </div>
            <div class="form-field">
              <label for="quantity">Quantity</label>
              <input class="input" id="quantity" name="quantity" type="number" min="1" value="1" required />
            </div>
            <div class="form-field span-12">
              <label for="material">Material Preference</label>
              <select class="input" id="material" name="material" required>
                <option value="">Select material</option>
                <option>Waffle</option>
                <option>Combweb</option>
                <option>Vortex Jacquard</option>
                <option>Mesh</option>
                <option>Iceburg</option>
                <option>Nano Check</option>
                <option>Closehole</option>
                <option>Drytec</option>
                <option>Wetlook</option>
                <option>Baby Pk</option>
                <option>Cool Tech</option>
                <option>Net</option>
              </select>
            </div>
            <div class="form-actions span-12">
              <button class="btn-primary" id="saveOrderBtn" type="submit"><span class="btn-spinner" style="display:none;width:16px;height:16px;border:2px solid #ffffff;border-top-color:transparent;border-radius:50%;margin-right:8px;vertical-align:middle;display:inline-block;animation: spin 0.8s linear infinite;"></span><span id="saveOrderText">Save Order</span></button>
            </div>
          </form>
        </div>
      </main>
    </div>
  </div>
      <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (window.lucide) window.lucide.createIcons();
      const form = document.getElementById('orderForm');
      const saveBtn = document.getElementById('saveOrderBtn');
      const saveText = document.getElementById('saveOrderText');
      const spinner = saveBtn ? saveBtn.querySelector('.btn-spinner') : null;
      const params = new URLSearchParams(window.location.search);
      const existingId = params.get('order');

      async function generateOrderId(){
        const year = new Date().getFullYear();
        let maxSeq = 0;
        const re = new RegExp('^ORD-' + year + '-(\\d+)$');
        
        try {
          // Query Firebase for existing orders
          if (window.firebaseServices && window.firebaseServices.db) {
            const snapshot = await window.firebaseServices.db.collection('orders').get();
            for (const doc of snapshot.docs) {
              const orderId = doc.id;
              const m = orderId.match(re);
              if (m) {
                const n = parseInt(m[1], 10);
                if (!Number.isNaN(n) && n > maxSeq) maxSeq = n;
              }
            }
          }
        } catch (e) {
          console.warn('Failed to query Firebase for order IDs, using fallback');
        }
        
        const next = String(maxSeq + 1).padStart(2, '0');
        return `ORD-${year}-${next}`;
      }

      // Prefill if editing existing order (load from both orders and orderDetails, orders takes precedence)
      if (existingId) {
        try {
          if (window.firebaseServices && window.firebaseServices.db) {
            const db = window.firebaseServices.db;
            let base = {};
            try {
              const orderSummary = await db.collection('orders').doc(existingId).get();
              if (orderSummary.exists) base = orderSummary.data() || {};
            } catch(_) {}
            try {
              const orderDetails = await db.collection('orderDetails').doc(existingId).get();
              if (orderDetails.exists) {
                // Merge but keep summary fields if present
                const details = orderDetails.data() || {};
                base = Object.assign({}, details, base);
              }
            } catch(_) {}

            // Apply to form fields if present
            Object.keys(base).forEach(function(k){
              var el = form.elements.namedItem(k);
              if (el && base[k] != null) el.value = base[k];
            });

            // Update UI to reflect edit mode
            var titleEl = document.querySelector('.topbar h1');
            if (titleEl) titleEl.textContent = 'Edit Order';
            if (saveText) saveText.textContent = 'Update Order';
          }
        } catch (e) {
          console.warn('Failed to load existing order:', e);
        }
      }
      function waitForFirebase(timeoutMs){
        return new Promise((resolve)=>{
          const start = Date.now();
          (function tick(){
            if (window.firebaseServices && window.firebaseServices.db) return resolve(true);
            if (Date.now() - start > timeoutMs) return resolve(false);
            setTimeout(tick, 50);
          })();
        });
      }

      form.addEventListener('submit', async function(e){
        e.preventDefault();
        if (spinner && saveText) { spinner.style.display='inline-block'; saveText.textContent='Saving...'; saveBtn.disabled = true; }
        try {
          const ready = await waitForFirebase(3000);
          if (!ready) throw new Error('Database unavailable');
          const data = Object.fromEntries(new FormData(form).entries());
          const id = existingId || await generateOrderId();
          // Save to Firestore only
          const db = window.firebaseServices.db;
          const createdAt = new Date().toISOString();
          const summary = {
            id,
            customerName: data.customerName || '',
            email: data.email || '',
            mobile: data.mobile || '',
            quantity: Number(data.quantity || 1),
            material: data.material || '',
            createdAt
          };
          await db.collection('orders').doc(id).set(summary, { merge: true });
          await db.collection('orderDetails').doc(id).set(data, { merge: true });
          // Redirect to Orders page regardless of current page
          window.location.href = 'orders.html';
        } catch (err) {
          alert('Failed to save order: ' + (err && err.message ? err.message : 'Unknown error'));
        } finally {
          if (spinner && saveText) { spinner.style.display='none'; saveText.textContent='Save Order'; saveBtn.disabled = false; }
        }
      });
    });
  </script>
</body>
</html>


