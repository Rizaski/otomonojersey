<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Otomate | Jersey OMS</title>
  <link rel="icon" type="image/png" href="public/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
  <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="./styles.css">
  <style>
    /* Critical CSS fallback */
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      background: #FFFFFF; 
      color: #000000; 
      font-family: "Inter", "Poppins", system-ui, -apple-system, sans-serif; 
      line-height: 1.5; 
    }
    .app-frame { display: flex; min-height: 100vh; }
    .sidebar { width: 280px; background: #fff; border-right: 1px solid #E0E0E0; }
    .main-area { flex: 1; background: #ffffff; }
    .topbar { background: #fff; border-bottom: 1px solid #E0E0E0; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; }
    .site-main { padding: 24px; }
    .card { background: #fff; border: 1px solid #E0E0E0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    .btn-primary { background: #D32F2F; color: #fff; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; }
    .input { width: 100%; padding: 12px; border: 1px solid #E0E0E0; border-radius: 8px; }
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
    .stat-card { background: #fff; border: 1px solid #E0E0E0; border-radius: 12px; padding: 20px; }
  </style>
  <script defer src="./script.js"></script>
  <script defer src="./js/config.js"></script>
  <script defer src="./js/security.js"></script>
  <script defer src="./js/firebase-init.js"></script>
  <script defer src="./js/error-handler.js"></script>
  <script defer src="./js/validation.js"></script>
  <script defer src="./js/performance.js"></script>
  <script defer src="./js/backup.js"></script>
  <script defer src="./js/api-service.js"></script>
  <script defer src="./js/tests.js"></script>
  <script defer src="./js/auth-check.js"></script>
  <script>
    // Register service worker for production
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then((registration) => {
            console.log('Service Worker registered successfully:', registration.scope);
          })
          .catch((error) => {
            console.error('Service Worker registration failed:', error);
          });
      });
    }
  </script>
  <meta name="description" content="A simple 12-column container layout with a table.">
  <meta name="color-scheme" content="light dark">
</head>
<body class="index-page">
  <div class="app-frame">
    <aside class="sidebar" id="sidebar">  
      <div class="sidebar-header">
        <span class="brand">
          <img src="public/logo.png" alt="Brand logo" class="brand-logo">
                </span>
        <button class="icon-btn" id="sidebarToggle" aria-label="Toggle sidebar">
          <span class="material-symbols-outlined">menu_open</span>
        </button>
      </div>
      <nav class="sidebar-nav">
        <a class="nav-item active" href="index.html">
          <i data-lucide="layout-dashboard"></i>
          <span>Overview</span>
        </a>
        <a class="nav-item" href="orders.html">
          <i data-lucide="shopping-bag"></i>
          <span>Orders</span>
        </a>
        <a class="nav-item" href="customers.html">
          <i data-lucide="users"></i>
          <span>Customers</span>
        </a>
        <a class="nav-item" href="billing.html">
          <i data-lucide="credit-card"></i>
          <span>Billing</span>
        </a>
        <a class="nav-item" href="reports.html">
          <i data-lucide="bar-chart-3"></i>
          <span>Updates</span>
        </a>
        <a class="nav-item" href="settings.html">
          <i data-lucide="settings"></i>
          <span>Settings</span>
        </a>
      </nav>
    </aside>

    <div class="main-area">
      <header class="topbar">
        <div class="topbar-left">
          <button id="mobileSidebarToggle" class="icon-btn only-mobile" aria-label="Toggle sidebar" title="Toggle sidebar"><span class="material-symbols-outlined">menu</span></button>
          <h1>Overview</h1>
        </div>
        <div class="topbar-actions">
          <button id="notifBtn" class="icon-circle fill-red" aria-label="Notifications"><i data-lucide="bell"></i><span class="badge-dot" id="notifDot" style="display:none"></span></button>
          <button id="profileBtn" class="icon-circle fill-red" aria-label="Profile"><i data-lucide="user"></i></button>
        </div>
        <!-- Notification Center Panel -->
        <div id="notifPanel" class="notif-panel" aria-hidden="true">
        <div class="notif-header">Notifications</div>
        <ul class="notif-list" id="notifList"></ul>
        <div style="display:flex; gap:8px; padding:8px 12px; justify-content:flex-end; border-top:1px solid var(--color-border); background:#fff;">
          <button id="notifMarkAll" class="action-btn" title="Mark all read"><i data-lucide="check"></i></button>
          <button id="notifClear" class="action-btn" title="Clear all"><i data-lucide="trash"></i></button>
        </div>
        </div>

        <!-- Profile Menu -->
        <div id="profileMenu" class="profile-menu" aria-hidden="true">
          <div class="profile-user-info">
            <div class="profile-user-name" id="profileUserName">Loading...</div>
            <div class="profile-user-role">Administrator</div>
          </div>
          <div class="profile-divider"></div>
          <a href="settings.html">Settings</a>
          <a href="#" id="logoutLink">Logout</a>
        </div>
      </header>

      <main class="site-main">
        <div class="container">
          <!-- Stats Row -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Total Orders</div>
              <div class="stat-value" id="statTotalOrders">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Orders Today</div>
              <div class="stat-value" id="statOrdersToday">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Customers</div>
              <div class="stat-value" id="statCustomers">0</div>
            </div>
            
          </div>

          <!-- Content Row -->
          <div class="content-grid">
            <div class="recent-orders-card">
              <div class="card-header">
                <h2>Recent Orders</h2>
              </div>
              <div class="orders-list" id="recentOrdersList">
                <!-- Orders will be populated here -->
              </div>
            </div>

            <div class="quick-actions-card">
              <div class="card-header">
                <h2>Quick Actions</h2>
              </div>
              <div class="actions-list">
                <div class="action-item">
                  <button class="action-icon new-order" id="qaNewOrder" aria-label="New Order">
                    <i data-lucide="plus"></i>
                  </button>
                  <span class="action-text">Create new order</span>
                </div>
                <div class="action-item">
                  <a class="action-icon" href="orders.html" aria-label="View orders">
                    <i data-lucide="list"></i>
                  </a>
                  <span class="action-text">Go to Orders</span>
                </div>
                <div class="action-item">
                  <a class="action-icon" href="customers.html" aria-label="View customers">
                    <i data-lucide="users"></i>
                  </a>
                  <span class="action-text">Go to Customers</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Charts Section -->
          <div class="charts-section">
            <div class="charts-grid">
              <!-- Orders Over Time Bar Chart -->
              <div class="chart-card">
                <div class="chart-header">
                  <h3>Orders Over Time</h3>
                  <div class="chart-subtitle">Last 7 days</div>
                </div>
                <div class="chart-container">
                  <canvas id="ordersChart" width="400" height="200"></canvas>
                </div>
              </div>

              <!-- Customer Distribution Donut Chart -->
              <div class="chart-card">
                <div class="chart-header">
                  <h3>Customer Distribution</h3>
                  <div class="chart-subtitle">Top customers by orders</div>
                </div>
                <div class="chart-container">
                  <canvas id="customersChart" width="400" height="200"></canvas>
                </div>
              </div>

              <!-- Size & Material Demand Line Chart -->
              <div class="chart-card chart-wide">
                <div class="chart-header">
                  <h3>Size & Material Demand</h3>
                  <div class="chart-subtitle">Popular sizes and materials</div>
                </div>
                <div class="chart-container">
                  <canvas id="demandChart" width="800" height="200"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
      
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      // Initialize Lucide icons
      if (window.lucide) window.lucide.createIcons();
      
      const qa = document.getElementById('qaNewOrder');
      if (qa) qa.addEventListener('click', function(){ window.location.href = 'order.html'; });

      function onFirebaseReady(cb){
        if (window.firebaseServices && window.firebaseServices.db) return cb();
        const iv = setInterval(function(){
          if (window.firebaseServices && window.firebaseServices.db) { clearInterval(iv); cb(); }
        }, 50);
      }

      // Real-time subscription + in-page cache
      function subscribeOrders(renderFn){
        const db = window.firebaseServices.db;
        if (!window.__ordersSub) {
          window.__ordersSub = db.collection('orders').orderBy('createdAt','desc').limit(50)
            .onSnapshot(function(snap){
              window.__ordersData = snap.docs.map(function(d){ return { id: d.id, ...d.data() }; });
              renderFn(window.__ordersData);
            }, function(){ renderFn([]); });
        } else {
          renderFn(window.__ordersData || []);
        }
      }

      function normalizeOrders(list){
        return (list||[]).map(o => ({
          id: o.id,
          customerName: o.customerName||'',
          quantity: Number(o.quantity||0),
          createdAt: o.createdAt || (o.issuedAt || new Date().toISOString())
        }));
      }

      (function(){
        const recentBody = document.getElementById('recentOrdersList');
        if (recentBody) recentBody.innerHTML = '<div class="order-item"><span class="muted">Loading…</span></div>';
        onFirebaseReady(function(){
          subscribeOrders(function(list){
          const orders = normalizeOrders(list);
          // Stats
      const statTotal = document.getElementById('statTotalOrders');
      const statToday = document.getElementById('statOrdersToday');
      const statCustomers = document.getElementById('statCustomers');
      if (statTotal) statTotal.textContent = String(orders.length);
      const todayStr = new Date().toDateString();
      const ordersToday = orders.filter(o => new Date(o.createdAt).toDateString() === todayStr).length;
      if (statToday) statToday.textContent = String(ordersToday);
      const uniqueCustomers = new Set(orders.map(o => (o.customerName||'').trim().toLowerCase()).filter(Boolean));
      if (statCustomers) statCustomers.textContent = String(uniqueCustomers.size);
      
      // Recent orders
      if (recentBody) {
        const top5 = [...orders].sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).slice(0,5);
        if (top5.length === 0) {
          recentBody.innerHTML = '<div class="order-item"><span class="muted">No orders yet</span></div>';
        } else {
          recentBody.innerHTML = top5.map(o => `
            <div class="order-item">
              <span class="order-id">${o.id}</span>
              <span class="order-customer">${o.customerName||''}</span>
              <span class="order-qty">(${o.quantity||0})</span>
              <span class="order-date">${new Date(o.createdAt).toLocaleDateString()}</span>
            </div>
          `).join('');
        }
      }

      // Initialize Charts
      initializeCharts(orders);

      });
      });
      })();

      // Chart initialization function
      function initializeCharts(orders) {
        if (typeof Chart === 'undefined') {
          console.warn('Chart.js not loaded');
          return;
        }

        // Orders Over Time Bar Chart
        const ordersCtx = document.getElementById('ordersChart');
        if (ordersCtx) {
          const ordersData = getOrdersOverTimeData(orders);
          new Chart(ordersCtx, {
            type: 'bar',
            data: {
              labels: ordersData.labels,
              datasets: [{
                label: 'Orders',
                data: ordersData.values,
                backgroundColor: 'rgba(211, 47, 47, 0.8)',
                borderColor: 'rgba(211, 47, 47, 1)',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    stepSize: 1
                  }
                }
              }
            }
          });
        }

        // Customer Distribution Donut Chart
        const customersCtx = document.getElementById('customersChart');
        if (customersCtx) {
          const customersData = getCustomerDistributionData(orders);
          new Chart(customersCtx, {
            type: 'doughnut',
            data: {
              labels: customersData.labels,
              datasets: [{
                data: customersData.values,
                backgroundColor: [
                  'rgba(211, 47, 47, 0.8)',
                  'rgba(244, 67, 54, 0.8)',
                  'rgba(255, 87, 34, 0.8)',
                  'rgba(255, 152, 0, 0.8)',
                  'rgba(76, 175, 80, 0.8)',
                  'rgba(33, 150, 243, 0.8)',
                  'rgba(156, 39, 176, 0.8)',
                  'rgba(96, 125, 139, 0.8)'
                ],
                borderWidth: 2,
                borderColor: '#fff'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: {
                    padding: 10,
                    usePointStyle: true
                  }
                }
              }
            }
          });
        }

        // Size & Material Demand Line Chart
        const demandCtx = document.getElementById('demandChart');
        if (demandCtx) {
          const demandData = getDemandData(orders);
          new Chart(demandCtx, {
            type: 'line',
            data: {
              labels: demandData.labels,
              datasets: demandData.datasets
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'top',
                  labels: {
                    usePointStyle: true
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    stepSize: 1
                  }
                }
              }
            }
          });
        }
      }

      // Data processing functions
      function getOrdersOverTimeData(orders) {
        const last7Days = [];
        const today = new Date();
        
        for (let i = 6; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          last7Days.push(date.toDateString());
        }

        const ordersByDay = {};
        last7Days.forEach(day => {
          ordersByDay[day] = 0;
        });

        orders.forEach(order => {
          const orderDate = new Date(order.createdAt).toDateString();
          if (ordersByDay.hasOwnProperty(orderDate)) {
            ordersByDay[orderDate]++;
          }
        });

        return {
          labels: last7Days.map(day => new Date(day).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })),
          values: last7Days.map(day => ordersByDay[day])
        };
      }

      function getCustomerDistributionData(orders) {
        const customerCounts = {};
        orders.forEach(order => {
          const customer = order.customerName || 'Unknown';
          customerCounts[customer] = (customerCounts[customer] || 0) + 1;
        });

        const sortedCustomers = Object.entries(customerCounts)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 8);

        return {
          labels: sortedCustomers.map(([name]) => name),
          values: sortedCustomers.map(([,count]) => count)
        };
      }

      function getDemandData(orders) {
        const sizes = {};
        const materials = {};

        orders.forEach(order => {
          // Count sizes (assuming order has size field or jerseys array)
          if (order.jerseys && Array.isArray(order.jerseys)) {
            order.jerseys.forEach(jersey => {
              const size = jersey.size || jersey.cat || 'Unknown';
              sizes[size] = (sizes[size] || 0) + 1;
            });
          } else if (order.size) {
            sizes[order.size] = (sizes[order.size] || 0) + 1;
          }

          // Count materials
          if (order.material) {
            materials[order.material] = (materials[order.material] || 0) + 1;
          }
        });

        const topSizes = Object.entries(sizes)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 5);

        const topMaterials = Object.entries(materials)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 5);

        return {
          labels: [...topSizes.map(([size]) => size), ...topMaterials.map(([material]) => material)],
          datasets: [
            {
              label: 'Sizes',
              data: [...topSizes.map(([,count]) => count), ...new Array(topMaterials.length).fill(0)],
              borderColor: 'rgba(211, 47, 47, 1)',
              backgroundColor: 'rgba(211, 47, 47, 0.2)',
              tension: 0.4,
              fill: false
            },
            {
              label: 'Materials',
              data: [...new Array(topSizes.length).fill(0), ...topMaterials.map(([,count]) => count)],
              borderColor: 'rgba(33, 150, 243, 1)',
              backgroundColor: 'rgba(33, 150, 243, 0.2)',
              tension: 0.4,
              fill: false
            }
          ]
        };
      }
    });
  </script>
  
  <script>
    (function(){
      var sidebar = document.getElementById('sidebar');
      var mobileToggle = document.getElementById('mobileSidebarToggle');
      if (mobileToggle && sidebar) {
        mobileToggle.addEventListener('click', function(){ sidebar.classList.toggle('open'); });
        sidebar.querySelectorAll('.nav-item').forEach(function(a){ a.addEventListener('click', function(){ sidebar.classList.remove('open'); }); });
      }
    })();
  </script>
</body>
</html>

