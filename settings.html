<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings | Jersey OMS</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
  <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <link rel="stylesheet" href="styles.css">
  <script defer src="script.js"></script>
  <script defer src="js/security.js"></script>
  <script defer src="js/error-handler.js"></script>
  <script defer src="js/validation.js"></script>
  <script defer src="js/performance.js"></script>
  <script defer src="js/backup.js"></script>
  <script defer src="js/api-service.js"></script>
</head>
<body>
  <div class="app-frame">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <span class="brand">
          <img src="public/logo.png" alt="Brand logo" class="brand-logo">
        </span>
        <button class="icon-btn" id="sidebarToggle" aria-label="Toggle sidebar">
          <span class="material-symbols-outlined">menu_open</span>
        </button>
      </div>
      <nav class="sidebar-nav">
        <a class="nav-item" href="index.html"><i data-lucide="layout-dashboard"></i><span>Overview</span></a>
        <a class="nav-item active" href="orders.html"><i data-lucide="shopping-bag"></i><span>Orders</span></a>
        <a class="nav-item" href="customers.html"><i data-lucide="users"></i><span>Customers</span></a>
        <a class="nav-item" href="billing.html"><i data-lucide="credit-card"></i><span>Billing</span></a>
        <a class="nav-item" href="reports.html"><i data-lucide="bar-chart-3"></i><span>Updates</span></a>
        <a class="nav-item" href="settings.html"><i data-lucide="settings"></i><span>Settings</span></a>
      </nav>
    </aside>

    <div class="main-area">
      <header class="topbar">
        <div class="topbar-left">
          <h1>Settings</h1>
        </div>
        <div class="topbar-actions">
          <button id="notifBtn" class="icon-circle fill-red" aria-label="Notifications"><i data-lucide="bell"></i><span class="badge-dot" id="notifDot" style="display:none"></span></button>
          <button id="profileBtn" class="icon-circle fill-red" aria-label="Profile"><i data-lucide="user"></i></button>
        </div>
        <!-- Notification Center Panel -->
        <div id="notifPanel" class="notif-panel" aria-hidden="true">
        <div class="notif-header">Notifications</div>
        <ul class="notif-list" id="notifList"></ul>
        <div style="display:flex; gap:8px; padding:8px 12px; justify-content:flex-end; border-top:1px solid var(--color-border); background:#fff;">
          <button id="notifMarkAll" class="action-btn" title="Mark all read"><i data-lucide="check"></i></button>
          <button id="notifClear" class="action-btn" title="Clear all"><i data-lucide="trash"></i></button>
        </div>
        </div>

        <!-- Profile Menu -->
        <div id="profileMenu" class="profile-menu" aria-hidden="true">
          <div class="profile-user-info">
            <div class="profile-user-name" id="profileUserName">Loading...</div>
            <div class="profile-user-role">Administrator</div>
          </div>
          <div class="profile-divider"></div>
          <a href="settings.html">Settings</a>
          <a href="#" id="logoutLink">Logout</a>
        </div>
      </header>

      <main class="site-main">
        <div class="container">
          <div class="card">
            <div class="card-header"><h2>Preferences</h2></div>
            <form id="settingsForm" class="form-grid" style="gap:16px;">
              <div class="form-field span-12">
                <label for="pref_name">Display Name</label>
                <input class="input" type="text" id="pref_name" name="name" placeholder="Your name" />
              </div>
              <div class="form-field span-12">
                <label for="pref_email">Email</label>
                <input class="input" type="email" id="pref_email" name="email" placeholder="you@example.com" />
              </div>
              <div class="form-field span-12">
                <label for="pref_theme">Theme</label>
                <select id="pref_theme" name="theme" class="input">
                  <option value="light">Light</option>
                  <option value="dark">Dark</option>
                </select>
              </div>
              <div class="form-actions span-12">
                <button id="saveSettings" type="submit" class="btn-primary">Save Settings</button>
              </div>
            </form>
          </div>

          <div class="card">
            <div class="card-header"><h2>Password Reset</h2></div>
            <form id="passwordResetForm" class="form-grid" style="gap:16px;">
              <div class="form-field span-12">
                <label for="current_password">Current Password</label>
                <input class="input" type="password" id="current_password" name="currentPassword" placeholder="Enter your current password" required />
              </div>
              <div class="form-field span-12">
                <label for="new_password">New Password</label>
                <input class="input" type="password" id="new_password" name="newPassword" placeholder="Enter your new password" required />
              </div>
              <div class="form-field span-12">
                <label for="confirm_password">Confirm New Password</label>
                <input class="input" type="password" id="confirm_password" name="confirmPassword" placeholder="Confirm your new password" required />
              </div>
              <div class="form-actions span-12">
                <button id="resetPassword" type="submit" class="btn-primary">Reset Password</button>
              </div>
            </form>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function(){ 
      if (window.lucide) window.lucide.createIcons(); 
      
      // Password reset functionality with production-ready security
      const passwordResetForm = document.getElementById('passwordResetForm');
      const currentPasswordInput = document.getElementById('current_password');
      const newPasswordInput = document.getElementById('new_password');
      const confirmPasswordInput = document.getElementById('confirm_password');
      const resetPasswordBtn = document.getElementById('resetPassword');
      
      // Production-ready password management
      async function getStoredPasswordHash() {
        return localStorage.getItem('userPasswordHash') || await window.SecurityManager.hashPassword('admin123');
      }
      
      async function savePasswordHash(password) {
        const hash = await window.SecurityManager.hashPassword(password);
        localStorage.setItem('userPasswordHash', hash);
      }
      
      // Enhanced password validation
      function validatePassword() {
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        // Use production validator
        const validation = window.DataValidator.validatePassword(newPassword);
        if (!validation.isValid) {
          window.UserErrorHandler.showError(`Password requirements: ${validation.errors.join(', ')}`, 'error', 8000);
          return false;
        }
        
        if (newPassword !== confirmPassword) {
          window.UserErrorHandler.showError('New password and confirm password do not match', 'error');
          return false;
        }
        
        return true;
      }
      
      // Handle password reset form submission with security
      passwordResetForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        try {
          const currentPassword = currentPasswordInput.value;
          const newPassword = newPasswordInput.value;
          const confirmPassword = confirmPasswordInput.value;
          
          // Rate limiting check
          const rateLimit = window.SecurityManager.checkRateLimit('password_reset');
          if (!rateLimit.allowed) {
            const remainingMinutes = Math.ceil(rateLimit.remainingTime / 60000);
            window.UserErrorHandler.showError(`Too many attempts. Try again in ${remainingMinutes} minutes.`, 'error', 10000);
            return;
          }
          
          // Validate current password
          const storedHash = await getStoredPasswordHash();
          const isCurrentPasswordValid = await window.SecurityManager.verifyPassword(currentPassword, storedHash);
          
          if (!isCurrentPasswordValid) {
            window.SecurityManager.recordLoginAttempt('password_reset', false);
            window.UserErrorHandler.showError('Current password is incorrect', 'error');
            return;
          }
          
          // Validate new password
          if (!validatePassword()) {
            return;
          }
          
          // Save new password hash
          await savePasswordHash(newPassword);
          window.SecurityManager.recordLoginAttempt('password_reset', true);
          
          // Clear form
          passwordResetForm.reset();
          
          // Show success message
          window.UserErrorHandler.showSuccess('Password has been successfully reset!');
          
          // Log security event
          window.ErrorHandler.logInfo('Password changed successfully', {
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent
          });
          
        } catch (error) {
          window.ErrorHandler.logError('Password reset failed', { error: error.message });
          window.UserErrorHandler.showError('An error occurred while resetting password. Please try again.', 'error');
        }
      });
      
      // Real-time password strength validation
      newPasswordInput.addEventListener('input', function() {
        const password = newPasswordInput.value;
        if (password.length > 0) {
          const validation = window.DataValidator.validatePassword(password);
          if (!validation.isValid) {
            const requirements = Object.entries(validation.requirements)
              .filter(([key, value]) => !value)
              .map(([key]) => key.replace(/([A-Z])/g, ' $1').toLowerCase());
            
            newPasswordInput.setCustomValidity(`Missing: ${requirements.join(', ')}`);
          } else {
            newPasswordInput.setCustomValidity('');
          }
        }
      });
      
      // Real-time password confirmation validation
      confirmPasswordInput.addEventListener('input', function() {
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        if (confirmPassword && newPassword !== confirmPassword) {
          confirmPasswordInput.setCustomValidity('Passwords do not match');
        } else {
          confirmPasswordInput.setCustomValidity('');
        }
      });
    });
  </script>
</body>
</html>


