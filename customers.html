<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customers | Jersey OMS</title>
  <link rel="icon" type="image/png" href="public/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
  <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <link rel="stylesheet" href="./styles.css">
  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script defer src="./js/cache-manager.js"></script>
  <script defer src="./js/skeleton-loader.js"></script>
  <script defer src="./js/firebase-bootstrap.js"></script>
  <script defer src="script.js"></script>
  <script defer src="js/config.js"></script>
  <script defer src="js/security.js"></script>
  <script defer src="js/error-handler.js"></script>
  <script defer src="js/validation.js"></script>
  <script defer src="js/performance.js"></script>
  <script defer src="js/backup.js"></script>
  <script defer src="js/api-service.js"></script>
  <script defer src="js/tests.js"></script>
  <script defer src="js/auth-check.js"></script>
  <script defer src="js/localstorage-manager.js"></script>
  <style>
    .filters { display: grid; grid-template-columns: 1fr repeat(2, minmax(120px, 180px)) auto; gap: 12px; align-items: center; margin: 16px 16px 0 16px; }
    .filters .action-btn { height: 40px; width: 40px; padding: 0; display: inline-flex; align-items: center; justify-content: center; }
    .filters .input, .filters select { height: 40px; }
    .table-wrap { margin: 16px; background: #fff; border: 1px solid var(--color-border); border-radius: 12px; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    thead th { text-align: left; padding: 12px; font-weight: 600; color: var(--color-text-secondary); background: var(--color-hover); }
    tbody td { padding: 12px; border-top: 1px solid var(--color-border); }
    .action-btn { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 8px; border: 1px solid var(--color-border); background: #fff; cursor: pointer; }
  </style>
</head>
<body>
  <div class="app-frame">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <span class="brand">
          <img src="public/logo.png" alt="Brand logo" class="brand-logo">
        </span>
        <button class="icon-btn" id="sidebarToggle" aria-label="Toggle sidebar">
          <span class="material-symbols-outlined">menu_open</span>
        </button>
      </div>
      <nav class="sidebar-nav">
        <a class="nav-item" href="index.html"><i data-lucide="layout-dashboard"></i><span>Overview</span></a>
        <a class="nav-item" href="orders.html"><i data-lucide="shopping-bag"></i><span>Orders</span></a>
        <a class="nav-item active" href="customers.html"><i data-lucide="users"></i><span>Customers</span></a>
        
        <a class="nav-item" href="reports.html"><i data-lucide="bar-chart-3"></i><span>Updates</span></a>
        <a class="nav-item" href="settings.html"><i data-lucide="settings"></i><span>Settings</span></a>
      </nav>
    </aside>

    <div class="main-area">
      <header class="topbar">
        <div class="topbar-left">
          <button id="mobileSidebarToggle" class="icon-btn only-mobile" aria-label="Toggle sidebar" title="Toggle sidebar"><span class="material-symbols-outlined">menu</span></button>
          <h1>Customers</h1>
        </div>
        <div class="topbar-actions">
          <button id="notifBtn" class="icon-circle fill-red" aria-label="Notifications"><i data-lucide="bell"></i><span class="badge-dot" id="notifDot" style="display:none"></span></button>
          <button id="profileBtn" class="icon-circle fill-red" aria-label="Profile"><i data-lucide="user"></i></button>
          <button class="icon-circle new-order" id="newOrderBtnCustomers" aria-label="New Order"><i data-lucide="plus"></i></button>
        </div>
        <!-- Notification Center Panel -->
        <div id="notifPanel" class="notif-panel" aria-hidden="true">
        <div class="notif-header">Notifications</div>
        <ul class="notif-list" id="notifList"></ul>
        <div style="display:flex; gap:8px; padding:8px 12px; justify-content:flex-end; border-top:1px solid var(--color-border); background:#fff;">
          <button id="notifMarkAll" class="action-btn" title="Mark all read"><i data-lucide="check"></i></button>
          <button id="notifClear" class="action-btn" title="Clear all"><i data-lucide="trash"></i></button>
        </div>
        </div>

        <!-- Profile Menu -->
        <div id="profileMenu" class="profile-menu" aria-hidden="true">
          <div class="profile-user-info">
            <div class="profile-user-name" id="profileUserName">Loading...</div>
            <div class="profile-user-role">Administrator</div>
          </div>
          <div class="profile-divider"></div>
          <a href="settings.html">Settings</a>
          <a href="#" id="logoutLink">Logout</a>
        </div>
      </header>

      <main class="site-main">
        <div class="filters">
          <input id="customerSearch" class="input" type="search" placeholder="Search customers..." />
          <select id="sortCustomers" class="input">
            <option value="name_asc">Name A–Z</option>
            <option value="name_desc">Name Z–A</option>
            <option value="orders_desc">Most Orders</option>
          </select>
          <button id="clearCustomers" class="action-btn" aria-label="Clear filters" title="Clear filters"><i data-lucide="x"></i></button>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Customer</th>
                <th>Contact</th>
                <th>Mobile</th>
                <th>Total Orders</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="customersBody"></tbody>
          </table>
        </div>
      </main>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      if (window.lucide) window.lucide.createIcons();
      const body = document.getElementById('customersBody');
      const search = document.getElementById('customerSearch');
      const sortSel = document.getElementById('sortCustomers');
      const clearBtn = document.getElementById('clearCustomers');
      const newOrderBtn = document.getElementById('newOrderBtnCustomers');

      function onFirebaseReady(cb){
        if (window.firebaseServices && window.firebaseServices.db) return cb();
        const iv = setInterval(function(){
          if (window.firebaseServices && window.firebaseServices.db) { clearInterval(iv); cb(); }
        }, 50);
      }

      function subscribeOrders(onChange){
        const db = window.firebaseServices.db;
        if (!window.__ordersSub) {
          window.__ordersSub = db.collection('orders').orderBy('createdAt','desc')
            .onSnapshot(function(snap){
              window.__ordersData = snap.docs.map(function(d){ return { id: d.id, ...d.data() }; });
              onChange(window.__ordersData);
            }, function(){ onChange([]); });
        } else {
          onChange(window.__ordersData || []);
        }
      }

      function key(name){ return (name||'').trim().toLowerCase(); }

      async function buildCustomers(){
        const orders = window.__ordersData || [];
        const map = new Map();
        for (const o of orders) {
          const k = key(o.customerName);
          if (!k) continue;
          if (!map.has(k)) map.set(k, { name: o.customerName, contact: o.email || o.mobile || '', mobile: o.mobile || '', orders: [] });
          map.get(k).orders.push(o);
        }
        return Array.from(map.values());
      }

      function apply(list){
        const q = (search.value||'').toLowerCase();
        let out = list.filter(c => !q || c.name.toLowerCase().includes(q) || (c.contact||'').toLowerCase().includes(q));
        switch (sortSel.value) {
          case 'name_desc': out.sort((a,b)=>b.name.localeCompare(a.name)); break;
          case 'orders_desc': out.sort((a,b)=>b.orders.length - a.orders.length); break;
          default: out.sort((a,b)=>a.name.localeCompare(b.name));
        }
        return out;
      }

      async function render(){
        const list = apply(await buildCustomers());
        const rows = list.map(c => {
          const ordersCount = c.orders.length;
          const ordersLink = `orders.html?customer=${encodeURIComponent(c.name)}`;
          return `<tr>
            <td>${c.name}</td>
            <td>${c.contact||''}</td>
            <td>${c.mobile||''}</td>
            <td>${ordersCount}</td>
            <td>
              <a class="action-btn" href="${ordersLink}" aria-label="View orders" title="View orders"><i data-lucide="list"></i></a>
              <button class="action-btn" onclick="window.location.href='order.html'" aria-label="New order" title="New order"><i data-lucide="plus"></i></button>
            </td>
          </td>`;
        });
        // Hide skeleton loader
        if (window.SkeletonLoader) {
          window.SkeletonLoader.hide('customersTableBody');
        }
        
        body.innerHTML = rows.length > 0 ? rows.join('') : '<tr><td colspan="5" class="muted">No customers found.</td></tr>';
        if (window.lucide) window.lucide.createIcons();
      }

      search.addEventListener('input', render);
      sortSel.addEventListener('change', render);
      clearBtn.addEventListener('click', ()=>{ search.value=''; sortSel.value='name_asc'; render(); });
      newOrderBtn.addEventListener('click', ()=>{ window.location.href = 'order.html'; });

      // Show skeleton loader
      if (window.SkeletonLoader) {
        window.SkeletonLoader.show('customersTableBody', 'table', { rows: 5, columns: 5 });
      } else {
        body.innerHTML = '<tr><td colspan="5" class="muted">Loading…</td></tr>';
      }
      function boot(){ onFirebaseReady(function(){ subscribeOrders(function(){ render(); }); }); }
      boot();
      window.addEventListener('pageshow', function(e){ if (e && e.persisted) { render(); } });
      document.addEventListener('visibilitychange', function(){ if (document.visibilityState === 'visible') { render(); } });
    });
  </script>
  
  <script>
    (function(){
      var sidebar = document.getElementById('sidebar');
      var mobileToggle = document.getElementById('mobileSidebarToggle');
      if (mobileToggle && sidebar) {
        mobileToggle.addEventListener('click', function(){ sidebar.classList.toggle('open'); });
        sidebar.querySelectorAll('.nav-item').forEach(function(a){ a.addEventListener('click', function(){ sidebar.classList.remove('open'); }); });
      }
    })();
  </script>
</body>
</html>


