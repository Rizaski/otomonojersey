<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client Submissions | Jersey OMS</title>
  <link rel="icon" type="image/png" href="public/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
  <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <link rel="stylesheet" href="./styles.css">
  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script defer src="./js/cache-manager.js"></script>
  <script defer src="./js/skeleton-loader.js"></script>
  <script defer src="./js/firebase-bootstrap.js"></script>
  <script defer src="./js/data-loader.js"></script>
  <script defer src="script.js"></script>
  <script defer src="js/config.js"></script>
  <script defer src="js/security.js"></script>
  <script defer src="js/error-handler.js"></script>
  <script defer src="js/validation.js"></script>
  <script defer src="js/performance.js"></script>
  <script defer src="js/backup.js"></script>
  <script defer src="js/api-service.js"></script>
  <script defer src="js/tests.js"></script>
  <script defer src="js/localstorage-manager.js"></script>
  <script defer src="js/zoho-books.js"></script>
  <script defer src="js/auth-check.js"></script>
  <style>
    .stats-grid { 
      display: grid; 
      grid-template-columns: repeat(3, 1fr); 
      gap: 20px; 
      margin: 24px 24px 0 24px; 
    }
    .stat-card { 
      background: #fff; 
      border: 1px solid var(--color-border); 
      border-radius: 12px; 
      padding: 20px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.04); 
      transition: box-shadow 180ms ease, transform 180ms ease; 
    }
    .stat-card:hover { 
      box-shadow: 0 4px 16px rgba(0,0,0,0.08); 
      transform: translateY(-1px); 
    }
    .stat-number { 
      font-size: 28px; 
      font-weight: 700; 
      color: var(--color-text); 
      line-height: 1.2; 
      font-family: 'Poppins', sans-serif;
    }
    .stat-label { 
      font-size: 12px; 
      font-weight: 600; 
      color: var(--color-text-secondary); 
      margin-bottom: 8px; 
      font-family: 'Poppins', sans-serif;
    }
    .filters { 
      display: grid; 
      grid-template-columns: 1fr repeat(2, minmax(120px, 180px)) auto auto; 
      gap: 15px; 
      align-items: center; 
      margin: 24px 24px 0 24px; 
    }
    .filters .action-btn { 
      height: 40px; 
      width: 40px; 
      padding: 0; 
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
    }
    .filters .input, .filters select { 
      height: 40px; 
    }
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    .table-wrap { 
      margin: 24px; 
      background: #fff; 
      border: 1px solid var(--color-border); 
      border-radius: 12px; 
      overflow: hidden; 
    }
    
    /* Apply rules.mdc responsive design */
    @media (max-width: 1024px) {
      .stats-grid { 
        grid-template-columns: repeat(3, 1fr); 
        gap: 20px; 
        margin: 24px 24px 0 24px; 
      }
      .filters { 
        grid-template-columns: 1fr repeat(2, minmax(100px, 150px)) auto auto; 
        gap: 15px; 
        margin: 24px 24px 0 24px; 
      }
      .table-wrap { 
        margin: 24px; 
      }
    }
    
    @media (max-width: 768px) {
      .stats-grid { 
        grid-template-columns: repeat(2, 1fr); 
        gap: 20px; 
        margin: 16px 16px 0 16px; 
      }
      .filters { 
        grid-template-columns: 1fr; 
        gap: 15px; 
        margin: 16px 16px 0 16px; 
      }
      .table-wrap { 
        margin: 16px; 
      }
    }
    
    @media (max-width: 480px) {
      .stats-grid { 
        grid-template-columns: 1fr; 
        gap: 20px; 
        margin: 16px 16px 0 16px; 
      }
    }
    
    .submission-row { 
      display: grid; 
      grid-template-columns: 1fr 2fr 1fr 1fr 1fr auto; 
      gap: 1rem; 
      padding: 1rem 1.5rem; 
      border-bottom: 1px solid var(--color-border); 
      align-items: center; 
    }
    .submission-row:last-child { 
      border-bottom: none; 
    }
    .submission-row:hover { 
      background: var(--color-hover); 
    }
    .order-id { 
      font-weight: 600; 
      color: var(--color-primary); 
      font-family: 'Poppins', sans-serif;
      font-size: 12px;
    }
    .customer-name { 
      font-weight: 500; 
      color: var(--color-text); 
      font-family: 'Poppins', sans-serif;
      font-size: 12px;
    }
    .status-badge { 
      padding: 0.25rem 0.75rem; 
      border-radius: 20px; 
      font-size: 10px; 
      font-weight: 600; 
      text-transform: uppercase; 
      letter-spacing: 0.5px; 
      font-family: 'Poppins', sans-serif;
    }
    .status-completed { 
      background: var(--color-success-light); 
      color: var(--color-success); 
    }
    .status-pending { 
      background: var(--color-warning-light); 
      color: var(--color-warning); 
    }
    .jersey-count { 
      text-align: center; 
      font-weight: 600; 
      color: var(--color-text-secondary); 
      font-family: 'Poppins', sans-serif;
      font-size: 12px;
    }
    .view-btn { 
      background: var(--color-primary); 
      color: white; 
      border: none; 
      padding: 0.5rem 1rem; 
      border-radius: 6px; 
      cursor: pointer; 
      font-size: 10px; 
      transition: background 0.2s; 
      font-family: 'Poppins', sans-serif;
    }
    .view-btn:hover { 
      background: var(--color-primary-dark); 
    }
    .no-submissions { 
      text-align: center; 
      padding: 3rem; 
      color: var(--color-text-secondary); 
    }
    .no-submissions h3 { 
      margin: 0 0 1rem 0; 
      color: var(--color-text-secondary); 
      font-family: 'Poppins', sans-serif;
      font-size: 12px;
    }
    .no-submissions p {
      font-family: 'Poppins', sans-serif;
      font-size: 10px;
    }
  </style>
</head>
<body>
  <div class="app-frame">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <span class="brand">
          <img src="public/logo.png" alt="Brand logo" class="brand-logo">
        </span>
        <button class="icon-btn" id="sidebarToggle" aria-label="Toggle sidebar">
          <span class="material-symbols-outlined">menu_open</span>
        </button>
      </div>
      <nav class="sidebar-nav">
        <a class="nav-item" href="index.html"><i data-lucide="layout-dashboard"></i><span>Overview</span></a>
        <a class="nav-item" href="orders.html"><i data-lucide="shopping-bag"></i><span>Orders</span></a>
        <a class="nav-item" href="customers.html"><i data-lucide="users"></i><span>Customers</span></a>
        <a class="nav-item active" href="client-submissions.html"><i data-lucide="file-text"></i><span>Client Submissions</span></a>
        <a class="nav-item" href="settings.html"><i data-lucide="settings"></i><span>Settings</span></a>
      </nav>
    </aside>

    <div class="main-area">
      <header class="topbar">
        <div class="topbar-left">
          <button id="mobileSidebarToggle" class="icon-btn only-mobile" aria-label="Toggle sidebar" title="Toggle sidebar"><span class="material-symbols-outlined">menu</span></button>
          <h1>Client Submissions</h1>
        </div>
        <div class="topbar-actions">
          <button id="notifBtn" class="icon-circle fill-red" aria-label="Notifications"><i data-lucide="bell"></i><span class="badge-dot" id="notifDot" style="display:none"></span></button>
          <button id="profileBtn" class="icon-circle fill-red" aria-label="Profile"><i data-lucide="user"></i></button>
          <button class="icon-circle new-order" id="newOrderBtn" aria-label="New Order"><i data-lucide="plus"></i></button>
        </div>
        <!-- Notification Center Panel -->
        <div id="notifPanel" class="notif-panel" aria-hidden="true">
        <div class="notif-header">Notifications</div>
        <ul class="notif-list" id="notifList"></ul>
        <div style="display:flex; gap:8px; padding:8px 12px; justify-content:flex-end; border-top:1px solid var(--color-border); background:#fff;">
          <button id="notifMarkAll" class="action-btn" title="Mark all read"><i data-lucide="check"></i></button>
          <button id="notifClear" class="action-btn" title="Clear all"><i data-lucide="trash"></i></button>
        </div>
        </div>

        <!-- Profile Menu -->
        <div id="profileMenu" class="profile-menu" aria-hidden="true">
          <div class="profile-user-info">
            <div class="profile-user-name" id="profileUserName">Loading...</div>
            <div class="profile-user-role">Administrator</div>
          </div>
          <div class="profile-divider"></div>
          <a href="settings.html">Settings</a>
          <a href="#" id="logoutLink">Logout</a>
        </div>
      </header>

      <main class="content">
        <!-- Statistics Cards -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total Submissions</div>
            <div class="stat-number" id="totalSubmissions">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Completed</div>
            <div class="stat-number" id="completedSubmissions">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Jerseys</div>
            <div class="stat-number" id="totalJerseys">0</div>
          </div>
        </div>

        <!-- Filters -->
        <div class="filters">
          <div class="input-group">
            <input type="text" id="searchInput" class="input" placeholder="Search submissions...">
            <i data-lucide="search" class="input-icon"></i>
          </div>
          <select id="statusFilter" class="input">
            <option value="">All Status</option>
            <option value="completed">Completed</option>
            <option value="pending">Pending</option>
          </select>
          <input type="date" id="dateFilter" class="input" placeholder="Filter by date">
          <div class="action-buttons">
            <button class="action-btn" id="refreshBtn" title="Refresh">
              <i data-lucide="refresh-cw"></i>
            </button>
            <button class="action-btn" id="exportBtn" title="Export">
              <i data-lucide="download"></i>
            </button>
          </div>
        </div>

        <!-- Submissions Table -->
        <div class="table-wrap">
          <div class="table-header">
            <h3>Client Submissions</h3>
          </div>
          <div class="table-content">
            <div id="submissionsContainer">
              <div class="no-submissions">
                <h3>Loading submissions...</h3>
                <p>Please wait while we fetch the data</p>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    // Simple, direct approach - no complex logic
    let submissionsData = [];
    let filteredData = [];

    // Load client submissions directly from Firebase
    async function loadClientSubmissions() {
      console.log('[ClientSubmissions] Loading client submissions...');
      
      if (!window.firebaseServices || !window.firebaseServices.db) {
        console.error('[ClientSubmissions] Firebase not available');
        showError('Firebase not available. Please check your internet connection and refresh the page.');
        return;
      }

      try {
        // Show loading state
        const container = document.getElementById('submissionsContainer');
        if (container) {
          container.innerHTML = `
            <div class="no-submissions">
              <h3>Loading submissions...</h3>
              <p>Please wait while we fetch the data from Firebase</p>
            </div>
          `;
        }
        const db = window.firebaseServices.db;
        
        // Get all orders
        console.log('[ClientSubmissions] Fetching orders...');
        const ordersSnap = await db.collection('orders').get();
        const orders = ordersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        console.log('[ClientSubmissions] Found orders:', orders.length);

        // Get all orderDetails
        console.log('[ClientSubmissions] Fetching order details...');
        const detailsSnap = await db.collection('orderDetails').get();
        const details = detailsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        console.log('[ClientSubmissions] Found order details:', details.length);

        // Check if we have any data
        if (orders.length === 0 && details.length === 0) {
          console.log('[ClientSubmissions] No data found in Firebase');
          showNoData();
          return;
        }

        // Combine data and find submissions
        const submissions = [];
        
        orders.forEach(order => {
          const detail = details.find(d => d.id === order.id);
          const combined = { ...order, ...detail };
          
          // Check if this order has client-submitted data
          const hasJerseys = !!(combined.jerseys && combined.jerseys.length > 0);
          const hasJerseyFields = !!(combined.jtype || combined.jname || combined.jnum);
          const hasSubmission = !!(combined.submittedAt && combined.status === 'completed');
          const hasAnyData = !!(combined.jerseys || combined.jtype || combined.jname || combined.jnum || combined.submittedAt);
          
          if (hasJerseys || hasJerseyFields || hasSubmission || hasAnyData) {
            submissions.push({
              id: order.id,
              customerName: combined.customerName || 'Unknown',
              email: combined.email || '',
              mobile: combined.mobile || '',
              jerseys: combined.jerseys || [],
              jerseyCount: combined.jerseys ? combined.jerseys.length : 0,
              submittedAt: combined.submittedAt || order.createdAt,
              status: combined.status || 'pending',
              hasDetails: true,
              rawData: combined
            });
          }
        });

        submissionsData = submissions;
        filteredData = [...submissions];
        console.log('[ClientSubmissions] Found submissions:', submissions.length);
        console.log('[ClientSubmissions] Submissions data:', submissions);

        // Update stats
        updateStats(submissions);
        
        // Display submissions
        displaySubmissions(filteredData);

      } catch (error) {
        console.error('[ClientSubmissions] Error loading submissions:', error);
        showError('Error loading submissions: ' + error.message);
      }
    }

    // Update statistics
    function updateStats(submissions) {
      const total = submissions.length;
      const completed = submissions.filter(s => s.status === 'completed').length;
      const totalJerseys = submissions.reduce((sum, s) => sum + s.jerseyCount, 0);

      document.getElementById('totalSubmissions').textContent = total;
      document.getElementById('completedSubmissions').textContent = completed;
      document.getElementById('totalJerseys').textContent = totalJerseys;

      console.log('[ClientSubmissions] Stats updated:', { total, completed, totalJerseys });
    }

    // Display submissions
    function displaySubmissions(submissions) {
      const container = document.getElementById('submissionsContainer');
      
      if (submissions.length === 0) {
        container.innerHTML = `
          <div class="no-submissions">
            <h3>No Client Submissions Found</h3>
            <p>No jersey details have been submitted by clients yet.</p>
          </div>
        `;
        return;
      }

      // Sort by submission date (newest first)
      submissions.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));

      const html = submissions.map(submission => {
        const statusClass = submission.status === 'completed' ? 'status-completed' : 'status-pending';
        const statusText = submission.status === 'completed' ? 'Completed' : 'Pending';
        const submittedDate = new Date(submission.submittedAt).toLocaleDateString();
        
        return `
          <div class="submission-row">
            <div class="order-id">${submission.id}</div>
            <div class="customer-name">${submission.customerName}</div>
            <div class="status-badge ${statusClass}">${statusText}</div>
            <div>${submittedDate}</div>
            <div class="jersey-count">${submission.jerseyCount} jerseys</div>
            <button class="view-btn" onclick="viewSubmission('${submission.id}')">View Details</button>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    // Filter submissions
    function filterSubmissions() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const dateFilter = document.getElementById('dateFilter').value;

      filteredData = submissionsData.filter(submission => {
        const matchesSearch = !searchTerm || 
          submission.customerName.toLowerCase().includes(searchTerm) ||
          submission.id.toLowerCase().includes(searchTerm) ||
          submission.email.toLowerCase().includes(searchTerm);
        
        const matchesStatus = !statusFilter || submission.status === statusFilter;
        
        const matchesDate = !dateFilter || 
          new Date(submission.submittedAt).toDateString() === new Date(dateFilter).toDateString();

        return matchesSearch && matchesStatus && matchesDate;
      });

      displaySubmissions(filteredData);
    }

    // View submission details
    function viewSubmission(orderId) {
      const submission = submissionsData.find(s => s.id === orderId);
      if (!submission) {
        alert('Submission not found');
        return;
      }

      // Create detailed view with professional brand theme
      const currentDate = new Date().toLocaleDateString();
      const submittedDate = new Date(submission.submittedAt).toLocaleDateString();
      
      let detailsHtml = `
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Submission Details - ${orderId}</title>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { 
              font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
              background: #f8f9fa; 
              color: #333; 
              line-height: 1.6; 
            }
            .document { 
              max-width: 800px; 
              margin: 20px auto; 
              background: white; 
              border-radius: 12px; 
              box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
              overflow: hidden; 
            }
            .header { 
              background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%); 
              color: white; 
              padding: 30px; 
              text-align: center; 
            }
            .logo { 
              width: 60px; 
              height: 60px; 
              margin: 0 auto 15px; 
              background: white; 
              border-radius: 12px; 
              display: flex; 
              align-items: center; 
              justify-content: center; 
              font-size: 24px; 
              font-weight: bold; 
              color: #D32F2F; 
            }
            .company-name { 
              font-size: 28px; 
              font-weight: 700; 
              margin-bottom: 5px; 
            }
            .document-title { 
              font-size: 18px; 
              opacity: 0.9; 
            }
            .content { 
              padding: 30px; 
            }
            .order-info { 
              background: #f8f9fa; 
              padding: 20px; 
              border-radius: 8px; 
              margin-bottom: 25px; 
            }
            .info-grid { 
              display: grid; 
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
              gap: 15px; 
            }
            .info-item { 
              display: flex; 
              flex-direction: column; 
            }
            .info-label { 
              font-size: 12px; 
              color: #666; 
              text-transform: uppercase; 
              letter-spacing: 0.5px; 
              margin-bottom: 5px; 
            }
            .info-value { 
              font-size: 16px; 
              font-weight: 600; 
              color: #333; 
            }
            .section-title { 
              font-size: 20px; 
              font-weight: 700; 
              color: #333; 
              margin: 25px 0 15px 0; 
              padding-bottom: 10px; 
              border-bottom: 2px solid #D32F2F; 
            }
            .jersey-table { 
              width: 100%; 
              border-collapse: collapse; 
              margin-top: 15px; 
            }
            .jersey-table th { 
              background: #D32F2F; 
              color: white; 
              padding: 12px; 
              text-align: left; 
              font-weight: 600; 
            }
            .jersey-table td { 
              padding: 12px; 
              border-bottom: 1px solid #eee; 
            }
            .jersey-table tr:nth-child(even) { 
              background: #f8f9fa; 
            }
            .footer { 
              background: #f8f9fa; 
              padding: 20px 30px; 
              text-align: center; 
              color: #666; 
              font-size: 14px; 
            }
            .close-btn { 
              background: #D32F2F; 
              color: white; 
              border: none; 
              padding: 12px; 
              border-radius: 6px; 
              cursor: pointer; 
              font-size: 16px; 
              margin-top: 20px; 
              width: 40px;
              height: 40px;
              display: inline-flex;
              align-items: center;
              justify-content: center;
            }
            .close-btn:hover { 
              background: #B71C1C; 
            }
            .download-btn { 
              background: #28a745; 
              color: white; 
              border: none; 
              padding: 12px; 
              border-radius: 6px; 
              cursor: pointer; 
              font-size: 16px; 
              margin: 10px 5px; 
              width: 40px;
              height: 40px;
              display: inline-flex;
              align-items: center;
              justify-content: center;
            }
            .download-btn:hover { 
              background: #218838; 
            }
            .download-btn.excel { 
              background: #1d6f42; 
            }
            .download-btn.excel:hover { 
              background: #155724; 
            }
            .download-btn:active, .close-btn:active {
              transform: scale(0.95);
            }
            .download-btn:hover, .close-btn:hover {
              transform: translateY(-2px);
              box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            }
            .status-badge { 
              display: inline-block; 
              padding: 4px 12px; 
              border-radius: 20px; 
              font-size: 12px; 
              font-weight: 600; 
              text-transform: uppercase; 
            }
            .status-completed { 
              background: #d4edda; 
              color: #155724; 
            }
            .status-pending { 
              background: #fff3cd; 
              color: #856404; 
            }
          </style>
        </head>
        <body>
          <div class="document">
            <div class="header">
              <div class="logo">JO</div>
              <div class="company-name">Jersey OMS</div>
              <div class="document-title">Client Submission Details</div>
            </div>
            
            <div class="content">
              <div class="order-info">
                <div class="info-grid">
                  <div class="info-item">
                    <div class="info-label">Order ID</div>
                    <div class="info-value">${orderId}</div>
                  </div>
                  <div class="info-item">
                    <div class="info-label">Customer Name</div>
                    <div class="info-value">${submission.customerName}</div>
                  </div>
                  <div class="info-item">
                    <div class="info-label">Email</div>
                    <div class="info-value">${submission.email || 'N/A'}</div>
                  </div>
                  <div class="info-item">
                    <div class="info-label">Mobile</div>
                    <div class="info-value">${submission.mobile || 'N/A'}</div>
                  </div>
                  <div class="info-item">
                    <div class="info-label">Status</div>
                    <div class="info-value">
                      <span class="status-badge ${submission.status === 'completed' ? 'status-completed' : 'status-pending'}">
                        ${submission.status === 'completed' ? 'Completed' : 'Pending'}
                      </span>
                    </div>
                  </div>
                  <div class="info-item">
                    <div class="info-label">Submitted Date</div>
                    <div class="info-value">${submittedDate}</div>
                  </div>
                </div>
              </div>

              <div class="section-title">Jersey Specifications</div>`;

      if (submission.jerseys && submission.jerseys.length > 0) {
        detailsHtml += `
          <table class="jersey-table">
            <thead>
              <tr>
                <th>Jersey #</th>
                <th>Type</th>
                <th>Name</th>
                <th>Number</th>
                <th>Category</th>
                <th>Size</th>
                <th>Sleeve</th>
                <th>Shorts</th>
              </tr>
            </thead>
            <tbody>`;
        
        submission.jerseys.forEach((jersey, index) => {
          detailsHtml += `
            <tr>
              <td>${index + 1}</td>
              <td>${jersey.jtype || 'N/A'}</td>
              <td>${jersey.jname || 'N/A'}</td>
              <td>${jersey.jnum || 'N/A'}</td>
              <td>${jersey.cat || 'N/A'}</td>
              <td>${jersey.size || 'N/A'}</td>
              <td>${jersey.sleeve || 'N/A'}</td>
              <td>${jersey.shorts || 'N/A'}</td>
            </tr>`;
        });
        
        detailsHtml += `
            </tbody>
          </table>`;
      } else {
        detailsHtml += `<p style="color: #666; font-style: italic;">No jersey details available</p>`;
      }

      detailsHtml += `
            </div>
            
            <div class="footer">
              <p>Generated on ${currentDate} | Jersey OMS - Professional Order Management System</p>
              <div style="margin-top: 15px;">
                <button class="download-btn" onclick="downloadPDF('${orderId}')" title="Download PDF">ðŸ“„</button>
                <button class="download-btn excel" onclick="downloadExcel('${orderId}')" title="Download Excel">ðŸ“Š</button>
                <button class="close-btn" onclick="window.close()" title="Close Document">âœ•</button>
              </div>
            </div>
          </div>
        </body>
        </html>`;

      // Show in new window
      const newWindow = window.open('', '_blank', 'width=900,height=700,scrollbars=yes');
      newWindow.document.write(detailsHtml);
      newWindow.document.close();
      
      // Add download functions to the new window
      newWindow.downloadPDF = function(orderId) {
        console.log('Downloading PDF for order:', orderId);
        try {
          // Get the order data
          const submission = submissionsData.find(s => s.id === orderId);
          if (!submission) {
            alert('Order data not found');
            return;
          }

          // Create PDF content (HTML that can be printed as PDF)
          const pdfContent = generatePDFContent(submission);
          
          // Create a new window for PDF generation
          const pdfWindow = window.open('', '_blank', 'width=800,height=600');
          pdfWindow.document.write(pdfContent);
          pdfWindow.document.close();
          
          // Add print functionality
          pdfWindow.onload = function() {
            pdfWindow.print();
            setTimeout(() => {
              pdfWindow.close();
            }, 1000);
          };
          
          console.log('PDF downloaded successfully');
        } catch (error) {
          console.error('Error downloading PDF:', error);
          alert('Error downloading PDF. Please try again.');
        }
      };
      
      newWindow.downloadExcel = function(orderId) {
        console.log('Downloading Excel for order:', orderId);
        try {
          // Get the order data
          const submission = submissionsData.find(s => s.id === orderId);
          if (!submission) {
            alert('Order data not found');
            return;
          }

          // Create Excel content (CSV format for simplicity)
          const csvContent = generateCSVContent(submission);
          
          // Create and download CSV
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `Order_${orderId}_${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          
          console.log('Excel/CSV downloaded successfully');
        } catch (error) {
          console.error('Error downloading Excel:', error);
          alert('Error downloading Excel. Please try again.');
        }
      };
    }

    // Generate PDF content (simplified HTML to PDF approach)
    function generatePDFContent(submission) {
      const currentDate = new Date().toLocaleDateString();
      const currentTime = new Date().toLocaleTimeString();
      
      // Create a simple HTML document that can be printed as PDF
      const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Order Details - ${submission.id}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            .header { text-align: center; margin-bottom: 30px; }
            .section { margin-bottom: 20px; }
            .label { font-weight: bold; }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #666; }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>Jersey Order Details</h1>
            <p>Order ID: ${submission.id}</p>
            <p>Generated on: ${currentDate} at ${currentTime}</p>
          </div>
          
          <div class="section">
            <h3>Customer Information</h3>
            <p><span class="label">Name:</span> ${submission.customerName || 'N/A'}</p>
            <p><span class="label">Email:</span> ${submission.email || 'N/A'}</p>
            <p><span class="label">Mobile:</span> ${submission.mobile || 'N/A'}</p>
            <p><span class="label">Status:</span> ${submission.status || 'N/A'}</p>
            <p><span class="label">Submitted:</span> ${submission.submittedAt ? new Date(submission.submittedAt).toLocaleString() : 'N/A'}</p>
          </div>
          
          <div class="section">
            <h3>Jersey Details</h3>
            ${submission.jerseys && submission.jerseys.length > 0 ? `
              <table>
                <thead>
                  <tr>
                    <th>Jersey Type</th>
                    <th>Jersey Name</th>
                    <th>Jersey Number</th>
                    <th>Size</th>
                    <th>Color</th>
                  </tr>
                </thead>
                <tbody>
                  ${submission.jerseys.map(jersey => `
                    <tr>
                      <td>${jersey.jtype || 'N/A'}</td>
                      <td>${jersey.jname || 'N/A'}</td>
                      <td>${jersey.jnum || 'N/A'}</td>
                      <td>${jersey.size || 'N/A'}</td>
                      <td>${jersey.color || 'N/A'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            ` : '<p>No jersey details available</p>'}
          </div>
          
          <div class="footer">
            <p>Generated by Jersey OMS - Professional Order Management System</p>
          </div>
        </body>
        </html>
      `;
      
      return htmlContent;
    }

    // Generate CSV content
    function generateCSVContent(submission) {
      const headers = ['Field', 'Value'];
      const rows = [
        ['Order ID', submission.id],
        ['Customer Name', submission.customerName || 'N/A'],
        ['Email', submission.email || 'N/A'],
        ['Mobile', submission.mobile || 'N/A'],
        ['Status', submission.status || 'N/A'],
        ['Submitted At', submission.submittedAt ? new Date(submission.submittedAt).toLocaleString() : 'N/A'],
        ['Jersey Count', submission.jerseyCount || 0],
        ['Total Amount', submission.totalAmount || 'N/A']
      ];

      // Add jersey details if available
      if (submission.jerseys && submission.jerseys.length > 0) {
        rows.push(['', '']); // Empty row separator
        rows.push(['Jersey Details', '']);
        rows.push(['Jersey Type', 'Jersey Name', 'Jersey Number', 'Size', 'Color']);
        
        submission.jerseys.forEach(jersey => {
          rows.push([
            jersey.jtype || 'N/A',
            jersey.jname || 'N/A',
            jersey.jnum || 'N/A',
            jersey.size || 'N/A',
            jersey.color || 'N/A'
          ]);
        });
      }

      // Convert to CSV format
      const csvContent = rows.map(row => 
        row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
      ).join('\n');

      return csvContent;
    }

    // Show error message
    function showError(message) {
      const container = document.getElementById('submissionsContainer');
      container.innerHTML = `
        <div class="no-submissions">
          <h3>Error</h3>
          <p>${message}</p>
          <button class="action-btn" onclick="loadClientSubmissions()">Try Again</button>
        </div>
      `;
    }

    // Show no data message
    function showNoData() {
      const container = document.getElementById('submissionsContainer');
      container.innerHTML = `
        <div class="no-submissions">
          <h3>No Submissions Found</h3>
          <p>No client submissions have been found in the database. This could mean:</p>
          <ul style="text-align: left; margin: 16px 0;">
            <li>No orders have been created yet</li>
            <li>No clients have submitted their jersey details</li>
            <li>The database is empty</li>
          </ul>
          <button class="action-btn" onclick="loadClientSubmissions()">Refresh</button>
        </div>
      `;
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[ClientSubmissions] Page loaded, initializing...');
      
      // Wait for Firebase to be ready with timeout
      let attempts = 0;
      const maxAttempts = 50; // 5 seconds max wait
      
      const checkFirebase = setInterval(() => {
        attempts++;
        
        if (window.firebaseServices && window.firebaseServices.db) {
          clearInterval(checkFirebase);
          console.log('[ClientSubmissions] Firebase ready, loading submissions...');
          loadClientSubmissions();
        } else if (attempts >= maxAttempts) {
          clearInterval(checkFirebase);
          console.error('[ClientSubmissions] Firebase initialization timeout');
          showError('Firebase initialization failed. Please refresh the page.');
        }
      }, 100);

      // Set up event listeners
      document.getElementById('searchInput').addEventListener('input', filterSubmissions);
      document.getElementById('statusFilter').addEventListener('change', filterSubmissions);
      document.getElementById('dateFilter').addEventListener('change', filterSubmissions);
      document.getElementById('refreshBtn').addEventListener('click', loadClientSubmissions);
      document.getElementById('exportBtn').addEventListener('click', () => {
        // Export functionality
        console.log('Export clicked');
      });
    });

    // Make functions globally available
    window.loadClientSubmissions = loadClientSubmissions;
    window.viewSubmission = viewSubmission;
  </script>
</body>
</html>