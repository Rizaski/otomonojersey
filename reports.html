<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Updates | Jersey OMS</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
  <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <link rel="stylesheet" href="styles.css">
  <script defer src="script.js"></script>
  <script defer src="js/config.js"></script>
  <script defer src="js/security.js"></script>
  <script defer src="js/error-handler.js"></script>
  <script defer src="js/validation.js"></script>
  <script defer src="js/performance.js"></script>
  <script defer src="js/backup.js"></script>
  <script defer src="js/api-service.js"></script>
  <script defer src="js/tests.js"></script>
  <style>
    .filters { display: grid; grid-template-columns: 1fr repeat(3, minmax(120px, 180px)); gap: 12px; align-items: center; margin: 16px 16px 0 16px; }
    .filters .input, .filters select { height: 40px; }
    .filters .action-btn { height: 40px; width: 40px; padding: 0; display: inline-flex; align-items: center; justify-content: center; }
    .table-wrap { margin: 16px; background: #fff; border: 1px solid var(--color-border); border-radius: 12px; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    thead th { text-align: left; padding: 12px; font-weight: 600; color: var(--color-text-secondary); background: var(--color-hover); }
    tbody td { padding: 12px; border-top: 1px solid var(--color-border); }
    .action-btn { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 8px; border: 1px solid var(--color-border); background: #fff; cursor: pointer; }
    .report-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 1200; opacity: 0; }
    .report-modal.show { display: flex; animation: fadeIn 160ms ease forwards; }
    .report-content { width: min(800px, 92vw); max-height: 80vh; background: #fff; border-radius: 14px; border: 1px solid var(--color-border); box-shadow: 0 6px 28px rgba(0,0,0,0.16); overflow: hidden; transform: scale(0.98); opacity: 0; }
    .report-modal.show .report-content { animation: popIn 160ms ease forwards; }
    .report-header { padding: 16px 20px; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; }
    .report-body { padding: 20px; max-height: 60vh; overflow-y: auto; }
    .report-section { margin-bottom: 24px; }
    .report-section h3 { margin: 0 0 12px 0; font-size: 16px; font-weight: 600; color: var(--color-text); border-bottom: 1px solid var(--color-border); padding-bottom: 8px; }
    .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .report-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
    .report-item:last-child { border-bottom: none; }
    .report-label { font-weight: 600; color: var(--color-text); }
    .report-value { color: var(--color-text-secondary); }
    @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
    @keyframes popIn { from { transform: scale(0.98); opacity: 0 } to { transform: scale(1); opacity: 1 } }
  </style>
</head>
<body>
  <div class="app-frame">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <span class="brand">
          <img src="public/logo.png" alt="Brand logo" class="brand-logo">
        </span>
        <button class="icon-btn" id="sidebarToggle" aria-label="Toggle sidebar">
          <span class="material-symbols-outlined">menu_open</span>
        </button>
      </div>
      <nav class="sidebar-nav">
        <a class="nav-item" href="index.html"><i data-lucide="layout-dashboard"></i><span>Overview</span></a>
        <a class="nav-item" href="orders.html"><i data-lucide="shopping-bag"></i><span>Orders</span></a>
        <a class="nav-item" href="customers.html"><i data-lucide="users"></i><span>Customers</span></a>
        <a class="nav-item" href="billing.html"><i data-lucide="credit-card"></i><span>Billing</span></a>
        <a class="nav-item active" href="reports.html"><i data-lucide="bar-chart-3"></i><span>Updates</span></a>
        <a class="nav-item" href="settings.html"><i data-lucide="settings"></i><span>Settings</span></a>
      </nav>
    </aside>

    <div class="main-area">
      <header class="topbar">
        <div class="topbar-left">
          <button id="mobileSidebarToggle" class="icon-btn only-mobile" aria-label="Toggle sidebar" title="Toggle sidebar"><span class="material-symbols-outlined">menu</span></button>
          <h1>Updates</h1>
        </div>
        <div class="topbar-actions">
          <button id="notifBtn" class="icon-circle fill-red" aria-label="Notifications"><i data-lucide="bell"></i><span class="badge-dot" id="notifDot" style="display:none"></span></button>
          <button id="profileBtn" class="icon-circle fill-red" aria-label="Profile"><i data-lucide="user"></i></button>
        </div>
        <!-- Notification Center Panel -->
        <div id="notifPanel" class="notif-panel" aria-hidden="true">
        <div class="notif-header">Notifications</div>
        <ul class="notif-list" id="notifList"></ul>
        <div style="display:flex; gap:8px; padding:8px 12px; justify-content:flex-end; border-top:1px solid var(--color-border); background:#fff;">
          <button id="notifMarkAll" class="action-btn" title="Mark all read"><i data-lucide="check"></i></button>
          <button id="notifClear" class="action-btn" title="Clear all"><i data-lucide="trash"></i></button>
        </div>
        </div>

        <!-- Profile Menu -->
        <div id="profileMenu" class="profile-menu" aria-hidden="true">
          <div class="profile-user-info">
            <div class="profile-user-name" id="profileUserName">Loading...</div>
            <div class="profile-user-role">Administrator</div>
          </div>
          <div class="profile-divider"></div>
          <a href="settings.html">Settings</a>
          <a href="#" id="logoutLink">Logout</a>
        </div>
      </header>

      <main class="site-main">
        <div class="filters">
          <input id="reportSearch" class="input" type="search" placeholder="Search updates..." />
          <select id="statusFilter" class="input">
            <option value="all">All Status</option>
            <option value="completed">Completed</option>
            <option value="pending">Pending</option>
          </select>
          <select id="sortReports" class="input">
            <option value="date_desc">Newest</option>
            <option value="date_asc">Oldest</option>
            <option value="customer_asc">Customer A–Z</option>
            <option value="customer_desc">Customer Z–A</option>
          </select>
          <button id="clearReports" class="action-btn" aria-label="Clear filters" title="Clear filters"><i data-lucide="x"></i></button>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Jersey Details</th>
                <th>Status</th>
                <th>Submitted</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="reportsBody"></tbody>
          </table>
        </div>
      </main>
    </div>
  </div>

  <!-- Report Details Modal -->
  <div id="reportModal" class="report-modal" aria-hidden="true">
    <div class="report-content">
      <div class="report-header">
        <h2 id="reportTitle">Order Report</h2>
        <button id="closeReport" class="action-btn" aria-label="Close" title="Close"><i data-lucide="x"></i></button>
      </div>
      <div class="report-body" id="reportBody">
        <!-- Report content will be populated here -->
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function(){
      if (window.lucide) window.lucide.createIcons();
      const body = document.getElementById('reportsBody');
      const search = document.getElementById('reportSearch');
      const statusFilter = document.getElementById('statusFilter');
      const sortSelect = document.getElementById('sortReports');
      const clearBtn = document.getElementById('clearReports');
      const reportModal = document.getElementById('reportModal');
      const reportBody = document.getElementById('reportBody');
      const reportTitle = document.getElementById('reportTitle');
      const closeReportBtn = document.getElementById('closeReport');
      
      if (!body) return;
      
      function loadReports(){
        try {
          const orders = JSON.parse(localStorage.getItem('orders') || '[]');
          const reports = [];
          
          // Get all order IDs and check for detailed data
          for (const order of orders) {
            const detailedData = localStorage.getItem(order.id);
            if (detailedData) {
              try {
                const details = JSON.parse(detailedData);
                reports.push({
                  ...order,
                  ...details,
                  hasDetails: true,
                  submittedAt: details.submittedAt || order.createdAt
                });
              } catch (e) {
                // If detailed data is corrupted, still show basic order
                reports.push({
                  ...order,
                  hasDetails: false,
                  submittedAt: order.createdAt
                });
              }
            }
          }
          
          return reports;
        } catch (e) {
          console.error('Error loading reports:', e);
          return [];
        }
      }
      
      function applyFilters(){
        const reports = loadReports();
        const searchTerm = (search.value || '').toLowerCase();
        const statusFilterValue = statusFilter.value;
        
        let filtered = reports.filter(report => {
          const matchesSearch = !searchTerm || 
            report.id.toLowerCase().includes(searchTerm) ||
            (report.customerName || '').toLowerCase().includes(searchTerm) ||
            (report.jname || '').toLowerCase().includes(searchTerm);
          
          const matchesStatus = statusFilterValue === 'all' || 
            (statusFilterValue === 'completed' && report.hasDetails) ||
            (statusFilterValue === 'pending' && !report.hasDetails);
          
          return matchesSearch && matchesStatus;
        });
        
        // Sort
        switch(sortSelect.value) {
          case 'date_asc':
            filtered.sort((a,b) => new Date(a.submittedAt) - new Date(b.submittedAt));
            break;
          case 'date_desc':
            filtered.sort((a,b) => new Date(b.submittedAt) - new Date(a.submittedAt));
            break;
          case 'customer_asc':
            filtered.sort((a,b) => (a.customerName || '').localeCompare(b.customerName || ''));
            break;
          case 'customer_desc':
            filtered.sort((a,b) => (b.customerName || '').localeCompare(a.customerName || ''));
            break;
        }
        
        return filtered;
      }
      
      function render(){
        const filteredReports = applyFilters();
        const rows = filteredReports.map(report => {
          const jerseyInfo = report.hasDetails ? 
            `${report.jtype || 'N/A'} - ${report.jname || 'N/A'} (${report.jnum || 'N/A'})` : 
            'Not submitted';
          
          const status = report.hasDetails ? 
            '<span style="color: var(--color-success); font-weight: 600;">Completed</span>' : 
            '<span style="color: var(--color-text-secondary);">Pending</span>';
          
          return `<tr>
            <td>${report.id}</td>
            <td>${report.customerName || 'N/A'}</td>
            <td>${jerseyInfo}</td>
            <td>${status}</td>
            <td>${new Date(report.submittedAt).toLocaleDateString()}</td>
            <td>
              <button class="action-btn" onclick="viewReport('${report.id}')" aria-label="View report" title="View report"><i data-lucide="eye"></i></button>
              ${report.hasDetails ? `<button class="action-btn" onclick="exportSingleOrder('${report.id}')" aria-label="Export to Excel" title="Export to Excel"><i data-lucide="download"></i></button>` : ''}
            </td>
          </tr>`;
        });
        body.innerHTML = rows.length > 0 ? rows.join('') : '<tr><td colspan="6" class="muted">No updates found.</td></tr>';
        if (window.lucide) window.lucide.createIcons();
      }

      // Event listeners
      search.addEventListener('input', render);
      statusFilter.addEventListener('change', render);
      sortSelect.addEventListener('change', render);
      clearBtn.addEventListener('click', () => {
        search.value = '';
        statusFilter.value = 'all';
        sortSelect.value = 'date_desc';
        render();
      });

      // Modal handlers
      closeReportBtn.addEventListener('click', () => {
        reportModal.setAttribute('aria-hidden', 'true');
        reportModal.classList.remove('show');
      });
      
      reportModal.addEventListener('click', (e) => {
        if (e.target === reportModal) {
          reportModal.setAttribute('aria-hidden', 'true');
          reportModal.classList.remove('show');
        }
      });

      // Excel export functionality - only exports orders with submitted details
      function exportToExcel() {
        try {
          const reports = loadReports();
          const filteredReports = applyFilters();
          
          // Filter to only include orders with submitted details
          const completedOrders = filteredReports.filter(report => report.hasDetails);
          
          if (completedOrders.length === 0) {
            alert('No orders with submitted details to export');
            return;
          }
          
          // Create Excel content
          let csvContent = 'Order ID,Customer Name,Quantity,Material,Email,Mobile,Jersey Type,Jersey Name,Jersey Number,Size Category,Size,Sleeve,Shorts,Status,Submitted Date\n';
          
          completedOrders.forEach(report => {
            const status = 'Completed';
            const submittedDate = new Date(report.submittedAt).toLocaleDateString();
            
            // Handle multiple jerseys if they exist
            if (report.jerseys && Array.isArray(report.jerseys)) {
              report.jerseys.forEach((jersey, index) => {
                csvContent += `"${report.id}","${report.customerName || 'N/A'}","${report.quantity || 'N/A'}","${report.material || 'N/A'}","${report.email || 'N/A'}","${report.mobile || 'N/A'}","${jersey.jtype || 'N/A'}","${jersey.jname || 'N/A'}","${jersey.jnum || 'N/A'}","${jersey.cat || 'N/A'}","${jersey.size || 'N/A'}","${jersey.sleeve || 'N/A'}","${jersey.shorts || 'N/A'}","${status}","${submittedDate}"\n`;
              });
            } else {
              // Single jersey format (backward compatibility)
              csvContent += `"${report.id}","${report.customerName || 'N/A'}","${report.quantity || 'N/A'}","${report.material || 'N/A'}","${report.email || 'N/A'}","${report.mobile || 'N/A'}","${report.jtype || 'N/A'}","${report.jname || 'N/A'}","${report.jnum || 'N/A'}","${report.cat || 'N/A'}","${report.size || 'N/A'}","${report.sleeve || 'N/A'}","${report.shorts || 'N/A'}","${status}","${submittedDate}"\n`;
            }
          });
          
          // Create and download file
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', `completed_jersey_orders_${new Date().toISOString().split('T')[0]}.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
        } catch (e) {
          console.error('Error exporting to Excel:', e);
          alert('Failed to export data: ' + e.message);
        }
      }

      // Export single order functionality
      window.exportSingleOrder = function(orderId) {
        try {
          const detailedData = localStorage.getItem(orderId);
          if (!detailedData) {
            alert('Order details not found');
            return;
          }
          
          const order = JSON.parse(detailedData);
          const hasDetails = order.jerseys && order.jerseys.length > 0 ? true : (order.jtype || order.jname || order.jnum);
          
          if (!hasDetails) {
            alert('This order has no submitted details to export');
            return;
          }
          
          const status = 'Completed';
          const submittedDate = new Date(order.submittedAt || order.createdAt).toLocaleDateString();
          
          // Create Excel content
          let csvContent = 'Order ID,Customer Name,Quantity,Material,Email,Mobile,Jersey Type,Jersey Name,Jersey Number,Size Category,Size,Sleeve,Shorts,Status,Submitted Date\n';
          
          // Handle multiple jerseys if they exist
          if (order.jerseys && Array.isArray(order.jerseys)) {
            order.jerseys.forEach((jersey, index) => {
              csvContent += `"${orderId}","${order.customerName || 'N/A'}","${order.quantity || 'N/A'}","${order.material || 'N/A'}","${order.email || 'N/A'}","${order.mobile || 'N/A'}","${jersey.jtype || 'N/A'}","${jersey.jname || 'N/A'}","${jersey.jnum || 'N/A'}","${jersey.cat || 'N/A'}","${jersey.size || 'N/A'}","${jersey.sleeve || 'N/A'}","${jersey.shorts || 'N/A'}","${status}","${submittedDate}"\n`;
            });
          } else {
            // Single jersey format (backward compatibility)
            csvContent += `"${orderId}","${order.customerName || 'N/A'}","${order.quantity || 'N/A'}","${order.material || 'N/A'}","${order.email || 'N/A'}","${order.mobile || 'N/A'}","${order.jtype || 'N/A'}","${order.jname || 'N/A'}","${order.jnum || 'N/A'}","${order.cat || 'N/A'}","${order.size || 'N/A'}","${order.sleeve || 'N/A'}","${order.shorts || 'N/A'}","${status}","${submittedDate}"\n`;
          }
          
          // Create and download file
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', `order_${orderId}_${new Date().toISOString().split('T')[0]}.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
        } catch (e) {
          console.error('Error exporting order to Excel:', e);
          alert('Failed to export order: ' + e.message);
        }
      };
      

      // View report function
      window.viewReport = function(orderId) {
        try {
          const detailedData = localStorage.getItem(orderId);
          if (!detailedData) {
            alert('Report not found');
            return;
          }
          
          const report = JSON.parse(detailedData);
          reportTitle.textContent = `Order Report - ${orderId}`;
          
          const reportContent = `
            <div class="report-section">
              <h3>Order Information</h3>
              <div class="report-grid">
                <div class="report-item">
                  <span class="report-label">Order ID:</span>
                  <span class="report-value">${orderId}</span>
                </div>
                <div class="report-item">
                  <span class="report-label">Customer Name:</span>
                  <span class="report-value">${report.customerName || 'N/A'}</span>
                </div>
                <div class="report-item">
                  <span class="report-label">Quantity:</span>
                  <span class="report-value">${report.quantity || 'N/A'}</span>
                </div>
                <div class="report-item">
                  <span class="report-label">Material:</span>
                  <span class="report-value">${report.material || 'N/A'}</span>
                </div>
                <div class="report-item">
                  <span class="report-label">Email:</span>
                  <span class="report-value">${report.email || 'N/A'}</span>
                </div>
                <div class="report-item">
                  <span class="report-label">Mobile:</span>
                  <span class="report-value">${report.mobile || 'N/A'}</span>
                </div>
              </div>
            </div>
            
            <div class="report-section">
              <h3>Jersey Specifications</h3>
              <div class="report-grid">
                <div class="report-item">
                  <span class="report-label">Jersey Type:</span>
                  <span class="report-value">${report.jtype || 'N/A'}</span>
                </div>
                <div class="report-item">
                  <span class="report-label">Jersey Name:</span>
                  <span class="report-value">${report.jname || 'N/A'}</span>
                </div>
                <div class="report-item">
                  <span class="report-label">Jersey Number:</span>
                  <span class="report-value">${report.jnum || 'N/A'}</span>
                </div>
                <div class="report-item">
                  <span class="report-label">Size Category:</span>
                  <span class="report-value">${report.cat || 'N/A'}</span>
                </div>
                <div class="report-item">
                  <span class="report-label">Size:</span>
                  <span class="report-value">${report.size || 'N/A'}</span>
                </div>
                <div class="report-item">
                  <span class="report-label">Sleeve:</span>
                  <span class="report-value">${report.sleeve || 'N/A'}</span>
                </div>
                <div class="report-item">
                  <span class="report-label">Shorts:</span>
                  <span class="report-value">${report.shorts || 'N/A'}</span>
                </div>
              </div>
            </div>
            
            <div class="report-section">
              <h3>Raw Data</h3>
              <div style="background: var(--color-hover); padding: 12px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">
                <pre style="margin: 0; white-space: pre-wrap;">${JSON.stringify(report, null, 2)}</pre>
              </div>
            </div>
          `;
          
          reportBody.innerHTML = reportContent;
          reportModal.setAttribute('aria-hidden', 'false');
          reportModal.classList.add('show');
          
        } catch (e) {
          console.error('Error loading report:', e);
          alert('Failed to load report: ' + e.message);
        }
      };

      render();
    });
  </script>
  
   <script>
     (function(){
       var sidebar = document.getElementById('sidebar');
       var mobileToggle = document.getElementById('mobileSidebarToggle');
       if (mobileToggle && sidebar) {
         mobileToggle.addEventListener('click', function(){ sidebar.classList.toggle('open'); });
         sidebar.querySelectorAll('.nav-item').forEach(function(a){ a.addEventListener('click', function(){ sidebar.classList.remove('open'); }); });
       }
     })();
   </script>
 </body>
</html>
