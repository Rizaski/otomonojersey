<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Billing | Jersey OMS</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
  <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <link rel="stylesheet" href="styles.css">
  <script defer src="script.js"></script>
  <script defer src="js/config.js"></script>
  <script defer src="js/security.js"></script>
  <script defer src="js/error-handler.js"></script>
  <script defer src="js/validation.js"></script>
  <script defer src="js/performance.js"></script>
  <script defer src="js/backup.js"></script>
  <script defer src="js/api-service.js"></script>
  <script defer src="js/tests.js"></script>
  <style>
    .filters { display: grid; grid-template-columns: 1fr repeat(3, minmax(120px, 180px)); gap: 12px; align-items: center; margin: 16px 16px 0 16px; }
    .filters .input, .filters select { height: 40px; }
    .filters .action-btn { height: 40px; width: 40px; padding: 0; display: inline-flex; align-items: center; justify-content: center; }
    .table-wrap { margin: 16px; background: #fff; border: 1px solid var(--color-border); border-radius: 12px; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    thead th { text-align: left; padding: 12px; font-weight: 600; color: var(--color-text-secondary); background: var(--color-hover); }
    tbody td { padding: 12px; border-top: 1px solid var(--color-border); }
    .action-btn { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 8px; border: 1px solid var(--color-border); background: #fff; cursor: pointer; }
  </style>
</head>
<body>
  <div class="app-frame">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <span class="brand">
          <img src="public/logo.png" alt="Brand logo" class="brand-logo">
        </span>
        <button class="icon-btn" id="sidebarToggle" aria-label="Toggle sidebar">
          <span class="material-symbols-outlined">menu_open</span>
        </button>
      </div>
      <nav class="sidebar-nav">
        <a class="nav-item" href="index.html"><i data-lucide="layout-dashboard"></i><span>Overview</span></a>
        <a class="nav-item" href="orders.html"><i data-lucide="shopping-bag"></i><span>Orders</span></a>
        <a class="nav-item" href="customers.html"><i data-lucide="users"></i><span>Customers</span></a>
        <a class="nav-item active" href="billing.html"><i data-lucide="credit-card"></i><span>Billing</span></a>
        <a class="nav-item" href="reports.html"><i data-lucide="bar-chart-3"></i><span>Updates</span></a>
        <a class="nav-item" href="settings.html"><i data-lucide="settings"></i><span>Settings</span></a>
      </nav>
    </aside>

    <div class="main-area">
      <header class="topbar">
        <div class="topbar-left">
          <button id="mobileSidebarToggle" class="icon-btn only-mobile" aria-label="Toggle sidebar" title="Toggle sidebar"><span class="material-symbols-outlined">menu</span></button>
          <h1>Billing</h1>
        </div>
        <div class="topbar-actions">
          <button id="notifBtn" class="icon-circle fill-red" aria-label="Notifications"><i data-lucide="bell"></i><span class="badge-dot" id="notifDot" style="display:none"></span></button>
          <button id="profileBtn" class="icon-circle fill-red" aria-label="Profile"><i data-lucide="user"></i></button>
        </div>
        <!-- Notification Center Panel -->
        <div id="notifPanel" class="notif-panel" aria-hidden="true">
        <div class="notif-header">Notifications</div>
        <ul class="notif-list" id="notifList"></ul>
        <div style="display:flex; gap:8px; padding:8px 12px; justify-content:flex-end; border-top:1px solid var(--color-border); background:#fff;">
          <button id="notifMarkAll" class="action-btn" title="Mark all read"><i data-lucide="check"></i></button>
          <button id="notifClear" class="action-btn" title="Clear all"><i data-lucide="trash"></i></button>
        </div>
        </div>

        <!-- Profile Menu -->
        <div id="profileMenu" class="profile-menu" aria-hidden="true">
          <div class="profile-user-info">
            <div class="profile-user-name" id="profileUserName">Loading...</div>
            <div class="profile-user-role">Administrator</div>
          </div>
          <div class="profile-divider"></div>
          <a href="settings.html">Settings</a>
          <a href="#" id="logoutLink">Logout</a>
        </div>
      </header>

      <main class="site-main">
        <div class="filters">
          <input id="invoiceSearch" class="input" type="search" placeholder="Search invoices..." />
          <select id="statusFilter" class="input">
            <option value="all">All Status</option>
            <option value="paid">Paid</option>
            <option value="unpaid">Unpaid</option>
          </select>
          <select id="sortInvoices" class="input">
            <option value="issued_desc">Newest</option>
            <option value="issued_asc">Oldest</option>
            <option value="total_desc">Highest Amount</option>
            <option value="total_asc">Lowest Amount</option>
            <option value="customer_asc">Customer Aâ€“Z</option>
          </select>
          <button id="clearInvoices" class="action-btn" aria-label="Clear filters" title="Clear filters"><i data-lucide="x"></i></button>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Invoice</th>
                <th>Order</th>
                <th>Customer</th>
                <th>Status</th>
                
                <th>Issued</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="invoiceBody"></tbody>
          </table>
        </div>
      </main>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function(){
      if (window.lucide) window.lucide.createIcons();
      const body = document.getElementById('invoiceBody');
      const search = document.getElementById('invoiceSearch');
      const statusFilter = document.getElementById('statusFilter');
      const sortSelect = document.getElementById('sortInvoices');
      const clearBtn = document.getElementById('clearInvoices');
      
      if (!body) return;
      
      function loadInvoices(){ try { return JSON.parse(localStorage.getItem('invoices')||'[]'); } catch { return []; } }
      function saveInvoices(list){ localStorage.setItem('invoices', JSON.stringify(list)); }
      
      // Clean up orphaned invoices (invoices without corresponding orders)
      function cleanupOrphanedInvoices() {
        const invoices = loadInvoices();
        const orders = JSON.parse(localStorage.getItem('orders') || '[]');
        const orderIds = new Set(orders.map(o => o.id));
        
        const validInvoices = invoices.filter(inv => orderIds.has(inv.orderId));
        
        if (validInvoices.length !== invoices.length) {
          saveInvoices(validInvoices);
          console.log(`Cleaned up ${invoices.length - validInvoices.length} orphaned invoices`);
        }
        
        return validInvoices;
      }

      function fmt(n){ return `$${(Number(n)||0).toFixed(2)}`; }
      
      function applyFilters(){
        const invoices = cleanupOrphanedInvoices(); // Use cleaned invoices
        const searchTerm = (search.value || '').toLowerCase();
        const statusFilterValue = statusFilter.value;
        
        let filtered = invoices.filter(inv => {
          const matchesSearch = !searchTerm || 
            inv.invoiceId.toLowerCase().includes(searchTerm) ||
            inv.orderId.toLowerCase().includes(searchTerm) ||
            inv.customerName.toLowerCase().includes(searchTerm);
          
          const matchesStatus = statusFilterValue === 'all' || 
            inv.status.toLowerCase() === statusFilterValue;
          
          return matchesSearch && matchesStatus;
        });
        
        // Sort
        switch(sortSelect.value) {
          case 'issued_asc':
            filtered.sort((a,b) => new Date(a.issuedAt) - new Date(b.issuedAt));
            break;
          case 'issued_desc':
            filtered.sort((a,b) => new Date(b.issuedAt) - new Date(a.issuedAt));
            break;
          
          case 'customer_asc':
            filtered.sort((a,b) => a.customerName.localeCompare(b.customerName));
            break;
        }
        
        return filtered;
      }
      
      function render(){
        const filteredInvoices = applyFilters();
        const orders = JSON.parse(localStorage.getItem('orders') || '[]');
        const orderIds = new Set(orders.map(o => o.id));
        
        const rows = filteredInvoices.map(inv => {
          const orderExists = orderIds.has(inv.orderId);
          const orderDisplay = orderExists ? inv.orderId : `<span style="color: #e53935; text-decoration: line-through;">${inv.orderId} (Deleted)</span>`;
          
          return `<tr>
            <td>${inv.invoiceId}</td>
            <td>${orderDisplay}</td>
            <td>${inv.customerName}</td>
            <td>${inv.status}</td>
            
            <td>${new Date(inv.issuedAt).toLocaleDateString()}</td>
            <td>
              <button class="action-btn" aria-label="Toggle status" title="Toggle status" data-invoice="${inv.invoiceId}"><i data-lucide="rotate-ccw"></i></button>
              ${!orderExists ? `<button class="action-btn" onclick="deleteInvoice('${inv.invoiceId}')" aria-label="Delete invoice" title="Delete invoice" style="color: #e53935;"><i data-lucide="trash"></i></button>` : ''}
            </td>
          </tr>`;
        }).join('');
        body.innerHTML = rows || '<tr><td colspan="6" class="muted">No invoices found.</td></tr>';
        if (window.lucide) window.lucide.createIcons();
      }

      // Event listeners
      search.addEventListener('input', render);
      statusFilter.addEventListener('change', render);
      sortSelect.addEventListener('change', render);
      clearBtn.addEventListener('click', () => {
        search.value = '';
        statusFilter.value = 'all';
        sortSelect.value = 'issued_desc';
        render();
      });

      body.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-invoice]');
        if (!btn) return;
        const id = btn.getAttribute('data-invoice');
        const invoices = loadInvoices();
        const inv = invoices.find(i=>i.invoiceId===id);
        if (!inv) return;
        inv.status = inv.status==='Paid' ? 'Unpaid' : 'Paid';
        saveInvoices(invoices);
        render();
      });

      // Delete invoice function
      window.deleteInvoice = function(invoiceId) {
        if (!confirm('Delete this invoice? This cannot be undone.')) return;
        try {
          const invoices = loadInvoices();
          const updatedInvoices = invoices.filter(inv => inv.invoiceId !== invoiceId);
          saveInvoices(updatedInvoices);
          render();
        } catch (e) {
          console.error('Error deleting invoice:', e);
          alert('Failed to delete invoice');
        }
      };

      render();
    });
  </script>
  
  <script>
    (function(){
      var sidebar = document.getElementById('sidebar');
      var mobileToggle = document.getElementById('mobileSidebarToggle');
      if (mobileToggle && sidebar) {
        mobileToggle.addEventListener('click', function(){ sidebar.classList.toggle('open'); });
        sidebar.querySelectorAll('.nav-item').forEach(function(a){ a.addEventListener('click', function(){ sidebar.classList.remove('open'); }); });
      }
    })();
  </script>
</body>
</html>


