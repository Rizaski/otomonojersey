<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Billing | Jersey OMS</title>
  <link rel="icon" type="image/png" href="public/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
  <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <link rel="stylesheet" href="./styles.css">
  <script defer src="script.js"></script>
  <script defer src="js/config.js"></script>
  <script defer src="js/security.js"></script>
  <script defer src="js/error-handler.js"></script>
  <script defer src="js/validation.js"></script>
  <script defer src="js/performance.js"></script>
  <script defer src="js/backup.js"></script>
  <script defer src="js/api-service.js"></script>
  <script defer src="js/auth-check.js"></script>
  <script defer src="js/tests.js"></script>
  <script defer src="js/localstorage-manager.js"></script>
  <script defer src="js/zoho-books.js"></script>
  <style>
    .filters { display: grid; grid-template-columns: 1fr repeat(3, minmax(120px, 180px)); gap: 12px; align-items: center; margin: 16px 16px 0 16px; }
    .filters .input, .filters select { height: 40px; }
    .filters .action-btn { height: 40px; width: 40px; padding: 0; display: inline-flex; align-items: center; justify-content: center; }
    .table-wrap { margin: 16px; background: #fff; border: 1px solid var(--color-border); border-radius: 12px; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    thead th { text-align: left; padding: 12px; font-weight: 600; color: var(--color-text-secondary); background: var(--color-hover); }
    tbody td { padding: 12px; border-top: 1px solid var(--color-border); }
    .action-btn { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 8px; border: 1px solid var(--color-border); background: #fff; cursor: pointer; }
  </style>
</head>
<body>
  <div class="app-frame">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <span class="brand">
          <img src="public/logo.png" alt="Brand logo" class="brand-logo">
        </span>
        <button class="icon-btn" id="sidebarToggle" aria-label="Toggle sidebar">
          <span class="material-symbols-outlined">menu_open</span>
        </button>
      </div>
      <nav class="sidebar-nav">
        <a class="nav-item" href="index.html"><i data-lucide="layout-dashboard"></i><span>Overview</span></a>
        <a class="nav-item" href="orders.html"><i data-lucide="shopping-bag"></i><span>Orders</span></a>
        <a class="nav-item" href="customers.html"><i data-lucide="users"></i><span>Customers</span></a>
        <a class="nav-item active" href="billing.html"><i data-lucide="credit-card"></i><span>Billing</span></a>
        <a class="nav-item" href="reports.html"><i data-lucide="bar-chart-3"></i><span>Updates</span></a>
        <a class="nav-item" href="settings.html"><i data-lucide="settings"></i><span>Settings</span></a>
      </nav>
    </aside>

    <div class="main-area">
      <header class="topbar">
        <div class="topbar-left">
          <button id="mobileSidebarToggle" class="icon-btn only-mobile" aria-label="Toggle sidebar" title="Toggle sidebar"><span class="material-symbols-outlined">menu</span></button>
          <h1>Billing</h1>
        </div>
        <div class="topbar-actions">
          <button id="zohoAuth" class="icon-circle fill-red" aria-label="Zoho Books Auth" title="Connect to Zoho Books"><i data-lucide="link"></i></button>
          <button id="notifBtn" class="icon-circle fill-red" aria-label="Notifications"><i data-lucide="bell"></i><span class="badge-dot" id="notifDot" style="display:none"></span></button>
          <button id="profileBtn" class="icon-circle fill-red" aria-label="Profile"><i data-lucide="user"></i></button>
        </div>
        <!-- Notification Center Panel -->
        <div id="notifPanel" class="notif-panel" aria-hidden="true">
        <div class="notif-header">Notifications</div>
        <ul class="notif-list" id="notifList"></ul>
        <div style="display:flex; gap:8px; padding:8px 12px; justify-content:flex-end; border-top:1px solid var(--color-border); background:#fff;">
          <button id="notifMarkAll" class="action-btn" title="Mark all read"><i data-lucide="check"></i></button>
          <button id="notifClear" class="action-btn" title="Clear all"><i data-lucide="trash"></i></button>
        </div>
        </div>

        <!-- Profile Menu -->
        <div id="profileMenu" class="profile-menu" aria-hidden="true">
          <div class="profile-user-info">
            <div class="profile-user-name" id="profileUserName">Loading...</div>
            <div class="profile-user-role">Administrator</div>
          </div>
          <div class="profile-divider"></div>
          <a href="settings.html">Settings</a>
          <a href="#" id="logoutLink">Logout</a>
        </div>
      </header>

      <main class="site-main">
        <div class="filters">
          <input id="invoiceSearch" class="input" type="search" placeholder="Search invoices..." />
          <select id="statusFilter" class="input">
            <option value="all">All Status</option>
            <option value="paid">Paid</option>
            <option value="unpaid">Unpaid</option>
          </select>
          <select id="sortInvoices" class="input">
            <option value="issued_desc">Newest</option>
            <option value="issued_asc">Oldest</option>
            <option value="total_desc">Highest Amount</option>
            <option value="total_asc">Lowest Amount</option>
            <option value="customer_asc">Customer Aâ€“Z</option>
          </select>
          <button id="clearInvoices" class="action-btn" aria-label="Clear filters" title="Clear filters"><i data-lucide="x"></i></button>
          <button id="refreshInvoices" class="action-btn" aria-label="Refresh invoices" title="Refresh invoices"><i data-lucide="refresh-cw"></i></button>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Invoice</th>
                <th>Order</th>
                <th>Customer</th>
                <th>Status</th>
                
                <th>Issued</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="invoiceBody"></tbody>
          </table>
        </div>
      </main>
    </div>
  </div>

  <!-- Global Themed Confirm Dialog -->
  <div id="appConfirm" class="dialog-backdrop" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="appConfirmTitle">
      <div class="dialog-header" id="appConfirmTitle">Confirm</div>
      <div class="dialog-body" id="appConfirmMessage"></div>
      <div class="dialog-actions">
        <button id="appConfirmCancel" class="action-btn" aria-label="Cancel" title="Cancel">
          <i data-lucide="x"></i>
          <span>Cancel</span>
        </button>
        <button id="appConfirmOk" class="action-btn action-btn-primary" aria-label="Confirm" title="Confirm">
          <i data-lucide="check"></i>
          <span>Confirm</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function(){
      if (window.lucide) window.lucide.createIcons();
      const body = document.getElementById('invoiceBody');
      const search = document.getElementById('invoiceSearch');
      const statusFilter = document.getElementById('statusFilter');
      const sortSelect = document.getElementById('sortInvoices');
      const clearBtn = document.getElementById('clearInvoices');
      const refreshBtn = document.getElementById('refreshInvoices');
      const zohoAuthBtn = document.getElementById('zohoAuth');
      
      if (!body) return;
      
      async function loadInvoices(){
        try {
          if (window.firebaseServices && window.firebaseServices.db) {
            const snap = await window.firebaseServices.db.collection('invoices').orderBy('issuedAt','desc').get();
            return snap.docs.map(d => ({ id: d.id, ...d.data() }));
          }
        } catch (e) { 
          console.warn('Firebase load failed, trying localStorage fallback:', e);
          try { return JSON.parse(localStorage.getItem('invoices')||'[]'); } catch { return []; }
        }
        return [];
      }
      async function saveInvoices(list){ 
        try {
          if (window.firebaseServices && window.firebaseServices.db) {
            const batch = window.firebaseServices.db.batch();
            list.forEach(inv => {
              const ref = window.firebaseServices.db.collection('invoices').doc(inv.invoiceId);
              batch.set(ref, inv, { merge: true });
            });
            await batch.commit();
            return;
          }
        } catch (e) { 
          console.warn('Firebase save failed, using localStorage fallback:', e);
        }
        localStorage.setItem('invoices', JSON.stringify(list)); 
      }
      
      // Clean up orphaned invoices (invoices without corresponding orders)
      async function cleanupOrphanedInvoices() {
        const invoices = await loadInvoices();
        let orders = [];
        try {
          if (window.firebaseServices && window.firebaseServices.db) {
            const snap = await window.firebaseServices.db.collection('orders').get();
            orders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          } else {
            orders = JSON.parse(localStorage.getItem('orders') || '[]');
          }
        } catch (e) {
          orders = JSON.parse(localStorage.getItem('orders') || '[]');
        }
        const orderIds = new Set(orders.map(o => o.id));
        
        const validInvoices = invoices.filter(inv => orderIds.has(inv.orderId));
        
        if (validInvoices.length !== invoices.length) {
          await saveInvoices(validInvoices);
          console.log(`Cleaned up ${invoices.length - validInvoices.length} orphaned invoices`);
        }
        
        return validInvoices;
      }

      function fmt(n){ return `$${(Number(n)||0).toFixed(2)}`; }
      
      async function applyFilters(){
        const invoices = await cleanupOrphanedInvoices(); // Use cleaned invoices
        const searchTerm = (search.value || '').toLowerCase();
        const statusFilterValue = statusFilter.value;
        
        let filtered = invoices.filter(inv => {
          const matchesSearch = !searchTerm || 
            inv.invoiceId.toLowerCase().includes(searchTerm) ||
            inv.orderId.toLowerCase().includes(searchTerm) ||
            inv.customerName.toLowerCase().includes(searchTerm);
          
          const matchesStatus = statusFilterValue === 'all' || 
            inv.status.toLowerCase() === statusFilterValue;
          
          return matchesSearch && matchesStatus;
        });
        
        // Sort
        switch(sortSelect.value) {
          case 'issued_asc':
            filtered.sort((a,b) => new Date(a.issuedAt) - new Date(b.issuedAt));
            break;
          case 'issued_desc':
            filtered.sort((a,b) => new Date(b.issuedAt) - new Date(a.issuedAt));
            break;
          
          case 'customer_asc':
            filtered.sort((a,b) => a.customerName.localeCompare(b.customerName));
            break;
        }
        
        return filtered;
      }
      
      async function render(){
        const filteredInvoices = await applyFilters();
        let orders = [];
        try {
          if (window.firebaseServices && window.firebaseServices.db) {
            const snap = await window.firebaseServices.db.collection('orders').get();
            orders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          } else {
            orders = JSON.parse(localStorage.getItem('orders') || '[]');
          }
        } catch (e) {
          orders = JSON.parse(localStorage.getItem('orders') || '[]');
        }
        const orderIds = new Set(orders.map(o => o.id));
        
        const rows = filteredInvoices.map(inv => {
          const orderExists = orderIds.has(inv.orderId);
          const orderDisplay = orderExists ? inv.orderId : `<span style="color: #e53935; text-decoration: line-through;">${inv.orderId} (Deleted)</span>`;
          
          return `<tr>
            <td>${inv.invoiceId}</td>
            <td>${orderDisplay}</td>
            <td>${inv.customerName}</td>
            <td>${inv.status}</td>
            
            <td>${new Date(inv.issuedAt).toLocaleDateString()}</td>
            <td>
              <button class="action-btn" aria-label="Toggle status" title="Toggle status" data-invoice="${inv.invoiceId}"><i data-lucide="rotate-ccw"></i></button>
              ${!inv.zohoInvoiceId ? `<button class="action-btn" onclick="syncToZoho('${inv.invoiceId}')" aria-label="Sync to Zoho Books" title="Sync to Zoho Books"><i data-lucide="upload"></i></button>` : `<button class="action-btn" onclick="viewZohoInvoice('${inv.zohoInvoiceId}')" aria-label="View in Zoho Books" title="View in Zoho Books"><i data-lucide="external-link"></i></button>`}
              ${!orderExists ? `<button class="action-btn" onclick="deleteInvoice('${inv.invoiceId}')" aria-label="Delete invoice" title="Delete invoice" style="color: #e53935;"><i data-lucide="trash"></i></button>` : ''}
            </td>
          </tr>`;
        }).join('');
        body.innerHTML = rows || '<tr><td colspan="6" class="muted">No invoices found.</td></tr>';
        if (window.lucide) window.lucide.createIcons();
      }

      // Event listeners
      search.addEventListener('input', async () => await render());
      statusFilter.addEventListener('change', async () => await render());
      sortSelect.addEventListener('change', async () => await render());
      clearBtn.addEventListener('click', async () => {
        search.value = '';
        statusFilter.value = 'all';
        sortSelect.value = 'issued_desc';
        await render();
      });

      refreshBtn.addEventListener('click', async () => {
        console.log('Manual refresh button clicked...');
        // Clear cached data to force fresh load
        window.__invoicesData = null;
        await render();
      });

      // Zoho Books authentication
      zohoAuthBtn.addEventListener('click', async () => {
        try {
          if (window.zohoBooks.isAuthenticated()) {
            const ok = await themedConfirm('You are already connected to Zoho Books. Do you want to reconnect?', 'Reconnect to Zoho Books');
            if (!ok) return;
            window.zohoBooks.logout();
          }
          
          // Show current redirect URI for debugging
          const currentUri = window.zohoBooks.getCurrentRedirectUri();
          console.log('Current redirect URI:', currentUri);
          
          // Open Zoho authorization in popup
          const authUrl = window.zohoBooks.getAuthUrl();
          console.log('Auth URL:', authUrl);
          const popup = window.open(authUrl, 'zoho_auth', 'width=600,height=700,scrollbars=yes,resizable=yes');
          
          // Check if popup is closed
          const checkClosed = setInterval(() => {
            if (popup.closed) {
              clearInterval(checkClosed);
              // Refresh the page to update auth status
              setTimeout(() => {
                window.location.reload();
              }, 1000);
            }
          }, 1000);
          
        } catch (error) {
          console.error('Zoho auth error:', error);
          alert('Failed to start Zoho Books authentication: ' + error.message + '\n\nCurrent redirect URI: ' + window.zohoBooks.getCurrentRedirectUri());
        }
      });


      body.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-invoice]');
        if (!btn) return;
        const id = btn.getAttribute('data-invoice');
        const invoices = await loadInvoices();
        const inv = invoices.find(i=>i.invoiceId===id);
        if (!inv) return;
        inv.status = inv.status==='Paid' ? 'Unpaid' : 'Paid';
        await saveInvoices(invoices);
        await render();
      });

      // Delete invoice function
      window.deleteInvoice = async function(invoiceId) {
        const ok = await themedConfirm('Delete this invoice? This cannot be undone.', 'Delete Invoice');
        if (!ok) return;
        try {
          const invoices = await loadInvoices();
          const updatedInvoices = invoices.filter(inv => inv.invoiceId !== invoiceId);
          await saveInvoices(updatedInvoices);
          await render();
        } catch (e) {
          console.error('Error deleting invoice:', e);
          alert('Failed to delete invoice');
        }
      };

      // Themed confirm helper
      function themedConfirm(message, title = 'Confirm'){
        return new Promise((resolve) => {
          const dlg = document.getElementById('appConfirm');
          const titleEl = document.getElementById('appConfirmTitle');
          const msg = document.getElementById('appConfirmMessage');
          const ok = document.getElementById('appConfirmOk');
          const cancel = document.getElementById('appConfirmCancel');
          if (!dlg || !msg || !ok || !cancel) return resolve(confirm(message));
          
          // Set title and message
          if (titleEl) titleEl.textContent = title;
          msg.textContent = message;
          dlg.classList.add('open');
          
          function cleanup(result){
            dlg.classList.remove('open');
            ok.removeEventListener('click', onOk);
            cancel.removeEventListener('click', onCancel);
            resolve(result);
          }
          function onOk(){ cleanup(true); }
          function onCancel(){ cleanup(false); }
          ok.addEventListener('click', onOk);
          cancel.addEventListener('click', onCancel);
        });
      }

      // Real-time subscription for invoices
      function subscribeInvoices(renderFn){
        if (!window.firebaseServices || !window.firebaseServices.db) {
          setTimeout(() => subscribeInvoices(renderFn), 100);
          return;
        }
        const db = window.firebaseServices.db;
        if (!window.__invoicesSub) {
          console.log('Setting up invoices real-time subscription...');
          window.__invoicesSub = db.collection('invoices').orderBy('issuedAt','desc')
            .onSnapshot(function(snap){
              console.log('Invoices updated, count:', snap.docs.length);
              window.__invoicesData = snap.docs.map(function(d){ return { id: d.id, ...d.data() }; });
              renderFn();
            }, function(err){ 
              console.warn('Invoices subscription error:', err);
              renderFn(); 
            });
        } else {
          console.log('Using existing invoices subscription');
          renderFn();
        }
      }

      // Override loadInvoices to use real-time data when available
      const originalLoadInvoices = loadInvoices;
      loadInvoices = async function(){
        if (window.__invoicesData) return window.__invoicesData;
        return await originalLoadInvoices();
      };

      // Initialize real-time subscription
      subscribeInvoices(async () => await render());
      
      // Force initial load
      setTimeout(async () => {
        console.log('Force loading invoices on page load...');
        await render();
      }, 500);

      // Refresh on page visibility change (when user returns to tab)
      document.addEventListener('visibilitychange', async function() {
        if (!document.hidden) {
          console.log('Page became visible, refreshing billing table...');
          await render();
        }
      });

      // Refresh on page show (back/forward navigation)
      window.addEventListener('pageshow', async function() {
        console.log('Page shown, refreshing billing table...');
        await render();
      });

      // Expose global refresh function for other pages to call
      window.refreshBillingTable = async function() {
        console.log('Manual refresh triggered for billing table...');
        await render();
      };

      // Listen for custom events from other pages
      window.addEventListener('invoiceCreated', async function() {
        console.log('Invoice created event received, refreshing billing table...');
        await render();
      });

      // Sync invoice to Zoho Books
      window.syncToZoho = async function(invoiceId) {
        try {
          if (!window.zohoBooks.isAuthenticated()) {
            alert('Please connect to Zoho Books first by clicking the link button.');
            return;
          }

          const invoices = await loadInvoices();
          const invoice = invoices.find(inv => inv.invoiceId === invoiceId);
          if (!invoice) {
            alert('Invoice not found');
            return;
          }

          if (invoice.zohoInvoiceId) {
            alert('This invoice is already synced to Zoho Books');
            return;
          }

          // Get order details for customer info
          let orderData = null;
          try {
            if (window.firebaseServices && window.firebaseServices.db) {
              const orderDoc = await window.firebaseServices.db.collection('orders').doc(invoice.orderId).get();
              if (orderDoc.exists) {
                orderData = orderDoc.data();
              }
            }
          } catch (e) {
            console.warn('Failed to get order data:', e);
          }

          const zohoInvoiceData = {
            invoiceId: invoice.invoiceId,
            orderId: invoice.orderId,
            customerName: invoice.customerName,
            email: orderData?.email || '',
            mobile: orderData?.mobile || '',
            total: invoice.total || 0
          };

          const ok = await themedConfirm(`Sync invoice ${invoiceId} to Zoho Books?`, 'Sync to Zoho Books');
          if (!ok) return;

          // Create invoice in Zoho Books
          const zohoInvoice = await window.zohoBooks.createInvoice(zohoInvoiceData);
          
          // Update local invoice with Zoho ID
          invoice.zohoInvoiceId = zohoInvoice.invoice_id;
          await saveInvoices(invoices);
          
          alert(`Invoice synced to Zoho Books successfully!\nZoho Invoice ID: ${zohoInvoice.invoice_id}`);
          await render();
          
        } catch (error) {
          console.error('Zoho sync error:', error);
          alert('Failed to sync to Zoho Books: ' + error.message);
        }
      };

      // View invoice in Zoho Books
      window.viewZohoInvoice = function(zohoInvoiceId) {
        const zohoUrl = `https://books.zoho.com/app#/invoices/${zohoInvoiceId}`;
        window.open(zohoUrl, '_blank');
      };
    });
  </script>
  
  <script>
    (function(){
      var sidebar = document.getElementById('sidebar');
      var mobileToggle = document.getElementById('mobileSidebarToggle');
      if (mobileToggle && sidebar) {
        mobileToggle.addEventListener('click', function(){ sidebar.classList.toggle('open'); });
        sidebar.querySelectorAll('.nav-item').forEach(function(a){ a.addEventListener('click', function(){ sidebar.classList.remove('open'); }); });
      }
    })();
  </script>
</body>
</html>


